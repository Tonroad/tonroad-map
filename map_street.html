<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TonRoad Street View</title>
  <style>
    html, body, #street-view {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
    }
    button {
      display: block;
      margin: 4px 0;
      width: 80px;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
</head>
<body>
  <div id="controls">
    <button onclick="castVote('left')">‚Üê Left</button>
    <button onclick="castVote('straight')">‚Üë Straight</button>
    <button onclick="castVote('right')">‚Üí Right</button>
    <button onclick="handleDrive()">üöó –ï–•–ê–¢–¨</button>
  </div>
  <div id="street-view"></div>

  <script>
    const supabaseUrl = "https://qsdaooxyznloogyheyu.supabase.co";
    const anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";

    const currentCity = "Novorossiysk";
    const currentMode = "default";

    let panorama;
    let currentPosition = { lat: 44.7239, lng: 37.7689 }; // Default start

    async function init() {
      const stored = await fetchCurrentPosition();
      if (stored) {
        currentPosition = stored;
      }

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"),
        {
          position: currentPosition,
          pov: { heading: 165, pitch: 0 },
          zoom: 1,
        }
      );
    }

    async function fetchCurrentPosition() {
      const res = await fetch(`${supabaseUrl}/rest/v1/current_position?city=eq.${currentCity}&select=lat,lng`, {
        headers: { apikey: anonKey, Authorization: `Bearer ${anonKey}` }
      });
      const data = await res.json();
      if (data.length > 0) {
        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lng) };
      }
      return null;
    }

    async function updateCurrentPosition(pos) {
      await fetch(`${supabaseUrl}/rest/v1/current_position?city=eq.${currentCity}`, {
        method: 'PATCH',
        headers: {
          apikey: anonKey,
          Authorization: `Bearer ${anonKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ lat: pos.lat, lng: pos.lng }),
      });
    }

    async function resetVotes() {
      await fetch(`${supabaseUrl}/rest/v1/rpc/reset_votes`, {
        method: 'POST',
        headers: {
          apikey: anonKey,
          Authorization: `Bearer ${anonKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ city_name: currentCity, mode_name: currentMode })
      });
    }

    async function getMajorityDirection() {
      const res = await fetch(`${supabaseUrl}/rest/v1/votes_summary?city=eq.${currentCity}&mode=eq.${currentMode}`, {
        headers: { apikey: anonKey, Authorization: `Bearer ${anonKey}` }
      });
      const data = await res.json();
      let maxCount = -1;
      let maxDirection = 'straight';
      data.forEach(row => {
        if (row.count > maxCount) {
          maxCount = row.count;
          maxDirection = row.direction;
        }
      });
      return maxDirection;
    }

    async function getNextPosition(direction) {
      const heading = panorama.getPov().heading;
      const step = 0.0005;
      let delta = { lat: 0, lng: 0 };

      if (direction === 'straight') {
        delta.lat = step * Math.cos(heading * Math.PI / 180);
        delta.lng = step * Math.sin(heading * Math.PI / 180);
      } else if (direction === 'left') {
        delta.lat = step * Math.cos((heading - 90) * Math.PI / 180);
        delta.lng = step * Math.sin((heading - 90) * Math.PI / 180);
      } else if (direction === 'right') {
        delta.lat = step * Math.cos((heading + 90) * Math.PI / 180);
        delta.lng = step * Math.sin((heading + 90) * Math.PI / 180);
      }

      return {
        lat: currentPosition.lat + delta.lat,
        lng: currentPosition.lng + delta.lng
      };
    }

    function updateMap(newPos) {
      currentPosition = newPos;
      panorama.setPosition(currentPosition);
    }

    async function castVote(direction) {
      await fetch(`${supabaseUrl}/rest/v1/rpc/increment_vote`, {
        method: 'POST',
        headers: {
          apikey: anonKey,
          Authorization: `Bearer ${anonKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          p_city: currentCity,
          p_mode: currentMode,
          p_direction: direction
        })
      });
    }

    async function handleDrive() {
      const direction = await getMajorityDirection();
      const next = await getNextPosition(direction);
      await updateCurrentPosition(next);
      await resetVotes();
      updateMap(next);
    }

    window.onload = init;
  </script>
</body>
</html>
