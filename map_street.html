<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TonRoad Map</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e2e2e2;
    }
    #map {
      height: 40%;
    }
    #pano {
      height: 60%;
    }
    #coords {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 999;
    }
    #mode-label {
      position: absolute;
      top: 0;
      left: 0;
      background: red;
      color: white;
      padding: 5px 15px;
      font-weight: bold;
      z-index: 999;
    }
    .vote-buttons {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 999;
    }
    .vote-buttons button {
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div id="mode-label">–†–µ–∂–∏–º: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
  <div id="coords">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ...</div>
  <div id="map"></div>
  <div id="pano"></div>

  <div class="vote-buttons">
    <button onclick="castVote('left')">‚¨ÖÔ∏è –í–ª–µ–≤–æ</button>
    <button onclick="castVote('straight')">‚¨ÜÔ∏è –ü—Ä—è–º–æ</button>
    <button onclick="castVote('right')">‚û°Ô∏è –í–ø—Ä–∞–≤–æ</button>
    <button onclick="drive()">üöó –ï–•–ê–¢–¨</button>
    <button onclick="location.reload()">üîÑ ‚Äî –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç—É</button>
  </div>

  <script>
    const anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const baseUrl = "https://qsdaooxywzloghveyuh.supabase.co/rest/v1";
    const headers = {
      "apikey": anonKey,
      "Authorization": `Bearer ${anonKey}`,
      "Content-Type": "application/json",
      "Prefer": "return=minimal"
    };

    const city = "Novorossiysk";
    const mode = "voting";

    let map, panorama;
    let currentPosition = { lat: 44.7236, lng: 37.7689 };
    let heading = 0;

    async function loadCurrentPosition() {
      const res = await fetch(`${baseUrl}/current_position?city=eq.${city}&order=updated_at.desc&limit=1`, { headers });
      const data = await res.json();
      if (data.length > 0) {
        currentPosition.lat = data[0].lat;
        currentPosition.lng = data[0].lng;
        heading = data[0].heading || 0;
      }
    }

    async function saveCurrentPosition() {
      await fetch(`${baseUrl}/current_position`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          city,
          lat: currentPosition.lat,
          lng: currentPosition.lng,
          heading
        })
      });
    }

    function updateCoordinatesDisplay() {
      const coordsEl = document.getElementById("coords");
      coordsEl.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}`;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: currentPosition,
        zoom: 15
      });

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("pano"),
        {
          position: currentPosition,
          pov: { heading: heading, pitch: 0 },
          visible: true
        }
      );

      map.setStreetView(panorama);

      panorama.addListener("position_changed", () => {
        currentPosition = {
          lat: panorama.getPosition().lat(),
          lng: panorama.getPosition().lng()
        };
        updateCoordinatesDisplay();
      });

      panorama.addListener("pov_changed", () => {
        heading = panorama.getPov().heading;
      });

      updateCoordinatesDisplay();
    }

    function castVote(direction) {
      fetch(`${baseUrl}/rpc/increment_vote`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          p_city: city,
          p_direction: direction,
          p_mode: mode
        })
      });
    }

    async function drive() {
      await saveCurrentPosition();
      await fetch(`${baseUrl}/rpc/reset_votes`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          city_name: city,
          mode_name: mode
        })
      });
      alert("üöó –ú–∞—à–∏–Ω–∞ –ø–æ–µ—Ö–∞–ª–∞!");
    }

    (async () => {
      await loadCurrentPosition();
      initMap();
    })();
  </script>
</body>
</html>
