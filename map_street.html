<!DOCTYPE html>
<html>
<head>
  <title>TonRoad Voting</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:33%; width:100%; }
    #street-view { height:67%; width:100%; }
    #modeLabel {
      position:absolute;
      top:10px; left:10px;
      background:green;
      color:white;
      padding:5px 10px;
      border-radius:4px;
      z-index:1000;
      cursor:pointer;
    }
    #citySelect {
      position:absolute;
      top:10px; right:10px;
      z-index:1000;
      padding:5px;
    }
    #radioToggle {
      position:absolute;
      top:50px; right:10px;
      background:orange;
      color:white;
      padding:5px 10px;
      border-radius:4px;
      z-index:1000;
      cursor:pointer;
    }
    #voteInfo {
      position:absolute;
      top:10px; left:200px;
      background:rgba(0,0,0,0.6);
      color:white;
      padding:5px 10px;
      border-radius:4px;
      z-index:1000;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосование: —</div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteState = { mode:"free", votes:{}, driveVotes:{}, timer:null };
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { lat:52.52, lng:13.405 },
  Leipzig: { lat:51.3397, lng:12.3731 },
  Dresden: { lat:51.0504, lng:13.7373 },
  Novorossiysk: { lat:44.7236, lng:37.7689 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom:14,
    center: cities.Berlin
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin,
    pov: { heading:0, pitch:0 },
    visible:true
  });

  map.setStreetView(streetView);

  document.getElementById("modeLabel").addEventListener("click", switchMode);
  document.getElementById("radioToggle").addEventListener("click", toggleRadio);

  document.getElementById("citySelect").addEventListener("change", e => {
    const city = cities[e.target.value];
    if (city) {
      map.setCenter(city);
      streetView.setPosition(city);
      streetView.setPov({ heading:0, pitch:0 });
    }
  });

  // отлавливаем реальные стрелки Гугл
  google.maps.event.addListener(streetView, "pov_changed", () => {
    if (voteState.mode === "voting") {
      handleVote(streetView.getPov().heading);
    }
  });
}

function handleVote(currentHeading) {
  const userId = window.telegramUserId || "unknown";

  let direction;
  if (currentHeading > 45 && currentHeading < 135) direction = "right";
  else if (currentHeading > 225 && currentHeading < 315) direction = "left";
  else direction = "straight";

  voteState.driveVotes[userId] = direction;

  const counts = {left:0, right:0, straight:0};
  Object.values(voteState.driveVotes).forEach(d => counts[d]++);

  document.getElementById("voteInfo").textContent =
    `Голосов: Влево ${counts.left} | Вправо ${counts.right} | Прямо ${counts.straight}`;

  // логика: если большинство — показываем надпись
  let maxDir = "straight";
  let maxCount = counts.straight;
  if (counts.left > maxCount) { maxCount = counts.left; maxDir = "left"; }
  if (counts.right > maxCount) { maxCount = counts.right; maxDir = "right"; }

  let chosen;
  if (direction === maxDir) {
    chosen = `Вы выбрали как большинство (${maxDir})`;
  } else {
    chosen = `Вы отклонились от большинства (большинство выбрало ${maxDir})`;
  }

  document.getElementById("voteInfo").textContent += ` | ${chosen}`;
}

function switchMode() {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    voteState.driveVotes = {};
    document.getElementById("voteInfo").style.display = "block";
  } else {
    voteState.mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    document.getElementById("voteInfo").style.display = "none";
  }
}

function toggleRadio() {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
}

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    console.log("Telegram SDK ready");
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("Telegram SDK error", e);
  }
};
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap"
  async defer>
</script>
</body>
</html>
