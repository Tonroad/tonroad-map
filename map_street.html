<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>TonRoad Voting & Driving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Google Maps API (твой ключ сохранён) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initApp" async defer></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    .map-container { height:30vh; width:100%; }
    .streetview-container { height:70vh; width:100%; position:relative; }
    .street-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0); z-index:1001; display:none; }
    .mode-label { position:absolute; top:10px; left:10px; background:red; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; z-index:1002; }
    .city-select { position:absolute; top:10px; right:10px; padding:5px; z-index:1002; }
    .vote-results { position:absolute; top:50px; left:10px; background:rgba(0,0,0,0.7); color:#fff; padding:5px 10px; border-radius:4px; z-index:1002; }
    .btn { position:absolute; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; z-index:1002; }
    .btn.radio { top:90px; right:10px; background:orange; color:#fff; }
    .radio-select { position:absolute; top:130px; right:10px; padding:5px; z-index:1002; background:#fff; color:#000; }
    .btn.drive { bottom:100px; right:10px; background:green; color:#fff; }
    .vote-buttons { position:absolute; bottom:20px; left:10px; z-index:1002; }
    .vote-buttons button { margin-right:5px; padding:8px 12px; }
  </style>
</head>
<body>
  <div id="modeLabel" class="mode-label">Режим: Голосование</div>
  <select id="citySelect" class="city-select">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults" class="vote-results">Влево: 0 | Прямо: 0 | Вправо: 0</div>

  <button id="radioToggle" class="btn radio">▶ Радио</button>
  <select id="radioSelect" class="radio-select">
    <option value="hitz">Radio Hitz</option>
    <option value="nashe">Наше Радио</option>
    <option value="record">Radio Record</option>
    <option value="rave">Rave Radio</option>
    <option value="donau">Donau3FM</option>
  </select>
  <audio id="radioAudio" preload="none" style="display:none;"></audio>

  <button id="driveButton" class="btn drive">ЕХАТЬ</button>

  <div id="map" class="map-container"></div>
  <div id="street-view" class="streetview-container">
    <div id="streetOverlay" class="street-overlay"></div>
  </div>

  <div class="vote-buttons">
    <button data-dir="left">← Влево</button>
    <button data-dir="straight">↑ Прямо</button>
    <button data-dir="right">→ Вправо</button>
  </div>

  <script>
    // MapManager управляет Google Map и StreetView
    class MapManager {
      constructor(mapEl, streetEl, cities) {
        this.cities = cities;
        this.map = new google.maps.Map(mapEl, { center: cities.Berlin, zoom: 14 });
        this.panorama = new google.maps.StreetViewPanorama(streetEl, {
          position: cities.Berlin,
          pov: { heading: 0, pitch: 0 },
          visible: true,
          clickToGo: true,
          linksControl: true
        });
        this.map.setStreetView(this.panorama);
      }
      setCity(key) {
        const pos = this.cities[key];
        this.map.setCenter(pos);
        this.panorama.setPosition(pos);
      }
      setInteraction(enabled) {
        this.panorama.setOptions({ clickToGo: enabled, linksControl: enabled });
      }
      findBestLink(dir) {
        const pov = this.panorama.getPov().heading;
        const links = this.panorama.getLinks() || [];
        if (!links.length) throw new Error('Нет связей для движения');
        const wantAngles = { straight: 0, left: 270, right: 90 };
        const want = wantAngles[dir];
        let best = { diff: Infinity, link: null };
        links.forEach(link => {
          let rel = (link.heading - pov + 360) % 360;
          let diff = Math.min(Math.abs(rel - want), 360 - Math.abs(rel - want));
          if (diff < best.diff) best = { diff, link };
        });
        if (!best.link) throw new Error('Нет подходящего поворота');
        return best.link;
      }
      rotateAndMove(dir) {
        const link = this.findBestLink(dir);
        this.panorama.setPov({ heading: link.heading, pitch: 0 });
        setTimeout(() => this.panorama.setPano(link.pano), 500);
      }
    }

    // VoteManager отвечает за загрузку, отправку и отображение голосов
    class VoteManager {
      constructor(city, mode, displayEl) {
        this.city = city;
        this.mode = mode;
        this.displayEl = displayEl;
        this.votes = { left:0, straight:0, right:0 };
      }
      async load() {
        const res = await fetch(`/api/votes/${this.city}/${this.mode}`);
        this.votes = await res.json();
        this.updateDisplay();
      }
      async vote(dir) {
        this.votes[dir]++;
        this.updateDisplay();
        await fetch(`/api/votes/${this.city}/${this.mode}?direction=${dir}`, { method:'POST' });
      }
      async reset() {
        this.votes = { left:0, straight:0, right:0 };
        await fetch(`/api/votes/${this.city}/${this.mode}?reset=true`, { method:'POST' });
        this.updateDisplay();
      }
      updateDisplay() {
        this.displayEl.textContent = `Влево: ${this.votes.left} | Прямо: ${this.votes.straight} | Вправо: ${this.votes.right}`;
      }
    }

    // RadioManager запускает аудио-фон через <audio>
    class RadioManager {
      constructor(toggleEl, selectEl) {
        this.audio = document.getElementById('radioAudio');
        this.audio.loop = true;
        this.audio.volume = 0.5;
        this.selectEl = selectEl;
        selectEl.addEventListener('change', () => this.audio.src = selectEl.value);
        this.audio.src = selectEl.value;
        toggleEl.addEventListener('click', () => this.toggle());
      }
      async toggle() {
        if (this.audio.paused) {
          try { await this.audio.play(); }
          catch(e){ console.error(e); }
        } else {
          this.audio.pause();
        }
      }
    }

    // Основной контроллер
    class AppController {
      constructor() {
        this.cities = {
          Berlin: { lat:52.52, lng:13.405 },
          Leipzig:{ lat:51.3397, lng:12.3731 },
          Dresden:{ lat:51.0504, lng:13.7373 },
          Novorossiysk:{ lat:44.7236, lng:37.7689 }
        };
        this.mode = 'voting';
        this.mapMgr = new MapManager(
          document.getElementById('map'),
          document.getElementById('street-view'),
          this.cities
        );
        this.voteMgr = new VoteManager(
          'Berlin', 'voting', document.getElementById('voteResults')
        );
        this.radioMgr = new RadioManager(
          document.getElementById('radioToggle'),
          document.getElementById('radioSelect')
        );
        this.overlay = document.getElementById('streetOverlay');
        this.setupUI();
        this.voteMgr.load();
        this.updateOverlay();
      }
      setupUI() {
        document.getElementById('modeLabel').onclick = () => this.toggleMode();
        document.getElementById('citySelect').onchange = async e => {
          this.mapMgr.setCity(e.target.value);
          this.voteMgr.city = e.target.value;
          await this.voteMgr.load();
        };
        document.querySelectorAll('.vote-buttons button').forEach(btn => {
          btn.onclick = () => this.voteMgr.vote(btn.dataset.dir);
        });
        document.getElementById('driveButton').onclick = () => this.drive();
      }
      toggleMode() {
        this.mode = this.mode==='voting'?'free':'voting';
        const lbl = document.getElementById('modeLabel');
        lbl.textContent = `Режим: ${this.mode==='voting'?'Голосование':'Свободная езда'}`;
        lbl.style.background = this.mode==='voting'?'red':'green';
        this.voteMgr.mode = this.mode;
        this.voteMgr.reset();
        this.updateOverlay();
      }
      updateOverlay() {
        const en = this.mode!=='voting';
        this.overlay.style.display = en?'none':'block';
        this.mapMgr.setInteraction(en);
      }
      async drive() {
        if (this.mode!=='voting') return;
        await this.voteMgr.load();
        const maxDir = ['left','straight','right']
          .reduce((a,b)=>this.voteMgr.votes[a]>this.voteMgr.votes[b]?a:b);
        try {
          this.mapMgr.rotateAndMove(maxDir);
          document.getElementById('voteResults')
            .textContent = `Вы поехали как большинство (${maxDir})`;
          // сохраняем новое положение
          await fetch(`/api/state/${this.voteMgr.city}/${this.mode}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              pano: this.mapMgr.panorama.getPano(),
              heading: this.mapMgr.panorama.getPov().heading
            })
          });
        } catch(e){
          console.warn(e);
          document.getElementById('voteResults')
            .textContent = 'Нет подходящего поворота';
        }
        this.voteMgr.reset();
      }
    }

    // Точка входа
    function initApp() {
      Telegram.WebApp.ready();
      new AppController();
    }
  </script>
</body>
</html>
