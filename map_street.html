<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TonRoad</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #modeLabel {
      position:absolute; top:5px; left:5px;
      background:red; color:white; padding:5px 10px; border-radius:4px;
      z-index:1000; cursor:pointer;
    }
    #citySelect {
      position:absolute; top:5px; right:5px;
      z-index:1000; padding:5px;
    }
    #radioToggle {
      position:absolute; top:50px; right:5px;
      z-index:1000; background:orange; color:white;
      padding:5px 10px; border-radius:4px; cursor:pointer;
    }
    #voteInfo {
      position:absolute; top:45px; left:5px;
      background:rgba(0,0,0,0.7); color:white;
      padding:5px 10px; border-radius:4px; z-index:1000;
      display:none;
    }
    #wrongTurn {
      position:absolute; bottom:5px; left:5px;
      background:red; color:white; padding:5px 10px; border-radius:4px;
      z-index:1000; display:none;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосование: ←0 | ↑0 | →0</div>
  <div id="wrongTurn">Вы не туда повернули!</div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true; radio.volume = 0.5;
let radioPlaying = false;

let voteState = {
  mode: "free",
  votes: {left:0, straight:0, right:0},
  selectedDir: null,
  timer: null
};

const cities = {
  Berlin: { lat:52.52, lng:13.405 },
  Leipzig: { lat:51.34, lng:12.373 },
  Dresden: { lat:51.05, lng:13.737 },
  Novorossiysk: { lat:44.723, lng:37.768 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom:14, center: cities.Berlin
  });
  streetView = new google.maps.StreetViewPanorama(
    document.getElementById("street-view"), {
      position: cities.Berlin,
      pov: {heading:0, pitch:0},
      visible:true
    });
  map.setStreetView(streetView);

  // магазины
  const shops = ["Рынок","Пекарня","Магазин одежды"];
  const infoWindow = new google.maps.InfoWindow({
    content: "Магазины: " + shops.join(", "),
    position: cities.Berlin
  });
  infoWindow.open(map);

  // переключение города
  document.getElementById("citySelect").addEventListener("change", e=>{
    const city = e.target.value;
    map.setCenter(cities[city]);
    streetView.setPosition(cities[city]);
  });
}

// режим
document.getElementById("modeLabel").addEventListener("click", ()=>{
  if (voteState.mode==="free") {
    voteState.mode="voting";
    document.getElementById("modeLabel").textContent="Режим: Голосование";
    document.getElementById("voteInfo").style.display="block";
    voteState.votes = {left:0, straight:0, right:0};
    voteState.selectedDir = null;
  }
  else if (voteState.mode==="voting") {
    voteState.mode="free";
    document.getElementById("modeLabel").textContent="Режим: Свободная езда";
    document.getElementById("voteInfo").style.display="none";
    voteState.selectedDir = null;
  }
});

// радио
document.getElementById("radioToggle").addEventListener("click", ()=>{
  if (radioPlaying) {
    radio.pause();
    document.getElementById("radioToggle").textContent="▶ Радио";
  } else {
    radio.play();
    document.getElementById("radioToggle").textContent="⏸ Радио";
  }
  radioPlaying = !radioPlaying;
});

// голосование по стрелкам
window.addEventListener("keydown", e=>{
  if (voteState.mode!=="voting") return;

  let dir = null;
  if (e.key==="ArrowLeft") dir="left";
  if (e.key==="ArrowUp") dir="straight";
  if (e.key==="ArrowRight") dir="right";

  if (dir) {
    voteState.votes[dir]++;
    updateVoteInfo();
    if (!voteState.selectedDir) {
      voteState.selectedDir=dir;
      document.getElementById("wrongTurn").style.display="none";
    }
  }
});

function updateVoteInfo() {
  document.getElementById("voteInfo").textContent=
    `Голосование: ←${voteState.votes.left} | ↑${voteState.votes.straight} | →${voteState.votes.right}`;
}

// обработка стрелок Google
google.maps.event.addListenerOnce(window, "load", ()=>{
  // имитация проверки направления (будто сверяем)
  setInterval(()=>{
    if (voteState.mode==="voting" && voteState.selectedDir) {
      let heading = streetView.getPov().heading;
      let ok=false;
      if (voteState.selectedDir==="left" && heading<0) ok=true;
      if (voteState.selectedDir==="straight" && heading>=0 && heading<180) ok=true;
      if (voteState.selectedDir==="right" && heading>0) ok=true;

      if (!ok) {
        document.getElementById("wrongTurn").style.display="block";
      } else {
        document.getElementById("wrongTurn").style.display="none";
      }
    }
  }, 2000);
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
