<!DOCTYPE html>
<html>
<head>
  <title>TonRoad голосование + радио</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: green;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      cursor: pointer;
    }
    #citySelect {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1000;
      padding: 5px;
    }
    #radioToggle {
      position: absolute;
      top: 50px; right: 10px;
      z-index: 1000;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #voteStatus {
      position: absolute;
      top: 80px; left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteStatus">Голосование: ⬅0 ⬆0 ➡0</div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteCounts = { left: 0, straight: 0, right: 0 };
let voteTimer = null;
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

let mode = "free"; // free / voting
const cities = {
  Berlin: { lat: 52.5200, lng: 13.4050 },
  Leipzig: { lat: 51.3397, lng: 12.3731 },
  Dresden: { lat: 51.0504, lng: 13.7373 },
  Novorossiysk: { lat: 44.7236, lng: 37.7689 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: cities.Berlin
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(streetView);

  document.getElementById("citySelect").addEventListener("change", e => {
    const city = cities[e.target.value];
    if (city) {
      map.setCenter(city);
      streetView.setPosition(city);
      streetView.setPov({ heading: 0, pitch: 0 });
    }
  });

  document.getElementById("modeLabel").addEventListener("click", switchMode);

  document.getElementById("radioToggle").addEventListener("click", () => {
    if (radioPlaying) {
      radio.pause();
      radioPlaying = false;
      document.getElementById("radioToggle").textContent = "▶ Радио";
    } else {
      radio.play();
      radioPlaying = true;
      document.getElementById("radioToggle").textContent = "⏸ Радио";
    }
  });

  // счёт голосов при кликах
  document.getElementById("street-view").addEventListener("click", e => {
    if (mode !== "voting") return;
    const w = e.target.offsetWidth;
    const x = e.offsetX;
    if (x < w/3) {
      voteCounts.left++;
    } else if (x > 2*w/3) {
      voteCounts.right++;
    } else {
      voteCounts.straight++;
    }
    updateVoteStatus();
  });
}

function switchMode() {
  if (mode === "free") {
    mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    voteCounts = { left: 0, straight: 0, right: 0 };
    updateVoteStatus();
    startVotingTimer();
  } else {
    mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    clearInterval(voteTimer);
  }
}

function updateVoteStatus() {
  document.getElementById("voteStatus").textContent =
    `Голосование: ⬅${voteCounts.left} ⬆${voteCounts.straight} ➡${voteCounts.right}`;
}

function startVotingTimer() {
  voteTimer = setInterval(() => {
    if (mode !== "voting") return;
    let max = Math.max(voteCounts.left, voteCounts.straight, voteCounts.right);
    let winner = "straight";
    if (voteCounts.left === max) winner = "left";
    if (voteCounts.right === max && voteCounts.right > voteCounts.left && voteCounts.right > voteCounts.straight) winner = "right";
    moveStreetView(winner);
    voteCounts = { left: 0, straight: 0, right: 0 };
    updateVoteStatus();
  }, 5000);
}

function moveStreetView(direction) {
  let pov = streetView.getPov();
  if (direction === "left") {
    pov.heading -= 30;
  } else if (direction === "right") {
    pov.heading += 30;
  }
  // прямо оставляем
  streetView.setPov(pov);
}

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("Telegram SDK init error", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
