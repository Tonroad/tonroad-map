<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TonRoad</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 33%; }
    #pano { height: 67%; }
    #modeLabel {
      position: absolute; top: 10px; left: 10px;
      background: red; color: white; padding: 5px 10px; z-index: 999;
      border-radius: 4px;
    }
    #voteInfo {
      position: absolute; top: 50px; left: 10px;
      background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; z-index: 999;
      border-radius: 4px;
    }
    #messageBox {
      position: absolute; top: 90px; left: 10px;
      background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; z-index: 999;
      border-radius: 4px;
      display: none;
    }
    #citySelect {
      position: absolute; top: 10px; right: 10px; z-index: 999;
      padding: 5px;
    }
    #radioToggle {
      position: absolute; top: 50px; right: 10px; z-index: 999;
      background: orange; color: white; padding: 5px 10px; border-radius: 4px;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Голосование</div>
  <select id="citySelect">
    <option value="Novorossiysk">Новороссийск</option>
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосов: ← 0 | ↑ 0 | → 0</div>
  <div id="messageBox"></div>
  <div id="map"></div>
  <div id="pano"></div>

<script>
let map, panorama;
let votes = { left: 0, straight: 0, right: 0 };
let mode = "voting";
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Novorossiysk: { lat: 44.7236, lng: 37.7689 },
  Berlin: { lat: 52.5200, lng: 13.4050 },
  Leipzig: { lat: 51.3397, lng: 12.3731 },
  Dresden: { lat: 51.0504, lng: 13.7373 }
};

function initMap() {
  const startCity = cities["Novorossiysk"];
  map = new google.maps.Map(document.getElementById("map"), {
    center: startCity,
    zoom: 15
  });
  panorama = new google.maps.StreetViewPanorama(
    document.getElementById("pano"), {
      position: startCity,
      pov: { heading: 0, pitch: 0 }
    }
  );
  map.setStreetView(panorama);

  // слушаем клик на стрелки
  panorama.addListener("position_changed", checkVoteResult);
}

function checkVoteResult() {
  if (mode !== "voting") return;

  let pov = panorama.getPov();
  let heading = pov.heading;

  // определяем направление
  let chosen;
  if (heading >= 315 || heading < 45) chosen = "straight";
  else if (heading >= 45 && heading < 135) chosen = "right";
  else if (heading >= 225 && heading < 315) chosen = "left";
  else chosen = "straight";

  let maxDir = Object.keys(votes).reduce((a,b) => votes[a]>votes[b]?a:b);
  
  if (votes[maxDir] === 0) return;

  let message = "";
  if (chosen === maxDir) {
    message = "✅ Едем по большинству!";
    document.getElementById("messageBox").style.background = "green";
  } else {
    message = "❌ Не туда повернули!";
    document.getElementById("messageBox").style.background = "red";
  }
  document.getElementById("messageBox").textContent = message;
  document.getElementById("messageBox").style.display = "block";
  setTimeout(()=> {
    document.getElementById("messageBox").style.display = "none";
  },2000);
}

function updateVoteInfo() {
  document.getElementById("voteInfo").textContent =
    `Голосов: ← ${votes.left} | ↑ ${votes.straight} | → ${votes.right}`;
}

document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

document.getElementById("citySelect").addEventListener("change", e => {
  let city = e.target.value;
  panorama.setPosition(cities[city]);
  map.setCenter(cities[city]);
  votes = { left: 0, straight: 0, right: 0 };
  updateVoteInfo();
});

document.getElementById("modeLabel").addEventListener("click", () => {
  if (mode === "voting") {
    mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
  } else {
    mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    votes = { left: 0, straight: 0, right: 0 };
    updateVoteInfo();
  }
});

// кнопки голосования
document.addEventListener("keydown", e => {
  if (mode !== "voting") return;
  if (e.key === "ArrowLeft") {
    votes.left++;
  } else if (e.key === "ArrowRight") {
    votes.right++;
  } else if (e.key === "ArrowUp") {
    votes.straight++;
  }
  updateVoteInfo();
});

window.onload = function() {
  try {
    Telegram.WebApp.ready();
  } catch {}
}
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap">
</script>
</body>
</html>
