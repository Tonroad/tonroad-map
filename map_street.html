<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <style>
    html, body {
      height: 100%; width: 100vw; margin: 0; padding: 0;
      font-family: Arial, sans-serif; background: #263544; color: #fff;
      box-sizing: border-box; overflow: hidden;
    }
    body {
      min-height: 100vh; width: 100vw; box-sizing: border-box;
      display: flex; flex-direction: column;
    }
    #app-container {
      display: flex; flex-direction: column;
      height: 100dvh;
      width: 100vw; box-sizing: border-box;
    }
    #headerBar {
      display: flex; align-items: center; gap: 5px;
      padding: 8px 4vw 6px 4vw;
      background: #212e3e; border-radius: 0 0 14px 14px; box-shadow: 0 2px 8px rgba(0,0,0,.12);
      min-height: 36px;
      font-size: 15px;
      flex-shrink: 0;
    }
    #cityLabel { font-size: 14px; font-weight: bold; }
    #citySelect {
      font-size: 14px; padding: 3px 14px; background: #26a96e; color: #fff; border: none;
      border-radius: 7px; font-weight: bold; box-shadow: 0 2px 8px rgba(38,169,110,.15);
      outline: none;
    }
    #voteResults {
      background: #2b3548; color: #fff; padding: 3px 11px;
      border-radius: 8px; font-size: 12px; font-weight: bold; margin-left: auto;
      box-shadow: 0 2px 8px rgba(34,43,56,.10);
    }
    #topPanel { flex-shrink: 0;}
    #timerLabel {
      font-size: 13px; background: #1b242f; color: #19e074;
      border-radius: 6px; padding: 4px 0; margin: 2px 8vw 0 8vw;
      text-align: center; font-weight: bold; box-shadow: 0 1px 8px rgba(34,43,56,.10);
      letter-spacing: 1px;
    }
    #main-content {
      flex: 1 1 auto; display: flex; flex-direction: column;
      min-height: 0; min-width: 0;
      overflow: hidden;
      position: relative;
    }
    #street-view {
      width: 100vw;
      height: 100%;
      flex: 1 1 auto;
      min-height: 0;
      min-width: 0;
      background: #263544;
      box-shadow: 0 1px 8px rgba(0,0,0,.07) inset;
      z-index: 1;
    }
    #controls {
      width: 100vw;
      display: flex; flex-direction: column; gap: 6px; align-items: center;
      justify-content: flex-end;
      padding-bottom: env(safe-area-inset-bottom, 12px);
      background: linear-gradient(0deg, #263544e8 80%, transparent 100%);
      position: absolute; left: 0; right: 0; bottom: 0; z-index: 2;
    }
    #voteBtns {
      display: flex; flex-direction: row; justify-content: center; gap: 5vw; width: 100vw;
      margin-bottom: 0;
    }
    .btn-vote {
      font-size: 22px; font-weight: bold; border: none; border-radius: 14px;
      padding: 12px 7vw; margin: 0; cursor: pointer; min-width: 56px; min-height: 40px;
      box-shadow: 0 1px 8px rgba(0,0,0,.06);
      outline: none;
      background: #222b38; color: #fff;
      transition: background .15s, transform .13s;
    }
    .btn-vote:active { background: #212e3e; transform: scale(.96);}
    .btn-vote.left    { background: #4d73e8; }
    .btn-vote.straight{ background: #2ecc71; }
    .btn-vote.right   { background: #ffc43c; color: #222;}
    #mainBtns {
      display: flex; flex-direction: row; justify-content: center; gap: 3vw; width: 100vw;
      margin-top: 0; margin-bottom: 6px;
    }
    .btn-main {
      font-size: 16px; font-weight: bold; border: none; border-radius: 11px;
      padding: 10px 3vw; min-width: 58px; min-height: 36px;
      margin: 0; cursor: pointer; box-shadow: 0 1px 8px rgba(0,0,0,.08);
      outline: none; transition: background .18s, transform .13s;
      display: flex; align-items: center; justify-content: center; letter-spacing: .3px;
    }
    .btn-main:active { transform: scale(.96);}
    .btn-main.start  { background: #3498db; color: #fff;}
    .btn-main.drive  { background: #26a96e; color: #fff;}
    .btn-main.back   { background: #ff9100; color: #fff;}
    .btn-main.radio  { background: #4ecbfa; color: #111; gap: 7px;}
    .btn-main.map    { background: #3498db; color: #fff;}
    #mapPopup {
      position: fixed; top: 0; left: 0; width: 100vw; height: 38vh; background: #fff;
      z-index: 2002; display: none; flex-direction: column;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.18);
      animation: popupShow .35s;
      padding-bottom: 2vw;
    }
    @keyframes popupShow {
      from { opacity: 0; transform: translateY(-30px);}
      to   { opacity: 1; transform: translateY(0);}
    }
    #hideMapBtn {
      background: #19e074; color: #111; font-size: 15px; font-weight: bold;
      padding: 8px 0; border-radius: 12px; border: none; margin: 8px 10vw 0 10vw; cursor: pointer;
      box-shadow: 0 2px 10px rgba(25,224,116,.12);
      transition: background .2s;
    }
    #hideMapBtn:active { background: #16b96a; }
    #mapCanvas {
      width: 100vw; height: 17vh; border-radius: 0 0 12px 12px; background: #e9f3ff;
    }
    @media (max-width: 600px) {
      html, body { font-size: 15px; }
      #voteBtns, #mainBtns { gap: 1vw; }
      .btn-vote, .btn-main { font-size: 14px; padding: 9px 1.7vw; min-width: 28px; min-height: 18px;}
      #voteResults { font-size: 11px;}
      #timerLabel { font-size: 12px;}
    }
    @media (max-width:400px) {
      #headerBar, #topPanel { font-size: 12px;}
      .btn-main, .btn-vote { font-size: 13px; min-height: 18px;}
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>
</head>
<body>
  <div id="app-container">
    <div id="headerBar">
      <span id="cityLabel">–ì–æ—Ä–æ–¥:</span>
      <select id="citySelect">
        <option value="Berlin">–ë–µ—Ä–ª–∏–Ω</option>
        <option value="Leipzig">–õ–µ–π–ø—Ü–∏–≥</option>
        <option value="Dresden">–î—Ä–µ–∑–¥–µ–Ω</option>
        <option value="Novorossiysk">–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫</option>
      </select>
      <span id="voteResults">–í–ª–µ–≤–æ: 0 | ‚Üë: 0 | –í–ø—Ä–∞–≤–æ: 0</span>
    </div>
    <div id="topPanel">
      <div id="timerLabel" style="display:none"></div>
    </div>
    <div id="main-content">
      <div id="street-view"></div>
      <div id="controls">
        <div id="voteBtns">
          <button class="btn-vote left" data-dir="left">‚Üê</button>
          <button class="btn-vote straight" data-dir="straight">‚Üë</button>
          <button class="btn-vote right" data-dir="right">‚Üí</button>
        </div>
        <div id="mainBtns">
          <button class="btn-main start">–°—Ç–∞—Ä—Ç</button>
          <button class="btn-main drive">–ï–•–ê–¢–¨</button>
          <button class="btn-main back">–ù–∞–∑–∞–¥</button>
          <button class="btn-main radio" onclick="window.open('https://t.me/fmusbot','_blank')">üéµ</button>
          <button class="btn-main map">–ö–∞—Ä—Ç–∞</button>
        </div>
      </div>
    </div>
    <div id="mapPopup">
      <button id="hideMapBtn">–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É ‚ñ≤</button>
      <div id="mapCanvas"></div>
    </div>
  </div>
  <script>
    // === –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const BASE_URL = "https://qsdaooxywznloogyheyu.supabase.co";
    const CITIES = {
      Berlin: { lat: 52.5200, lng: 13.4050 },
      Leipzig: { lat: 51.3397, lng: 12.3731 },
      Dresden: { lat: 51.0504, lng: 13.7373 },
      Novorossiysk: { lat: 44.7236, lng: 37.7689 }
    };
    let selectedCity = localStorage.getItem("selectedCity") || "Berlin";
    document.getElementById("citySelect").value = selectedCity;
    let panorama, streetMap, mapPopup, mapRoutePath;
    let votes = { left: 0, straight: 0, right: 0 };
    let timerValue = 0, timerActive = false, timerInterval = null;
    let routeHistory = {};
    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };
    async function initApp() {
      // === –í–û–¢ –≠–¢–û–¢ –ë–õ–û–ö –ò–ó–ú–ï–ù–Å–ù! ===
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById('street-view'),
        {
          position: CITIES[selectedCity],
          pov: { heading: 0, pitch: 0 },
          visible: true,
          addressControl: false,
          linksControl: false,
          panControl: false,
          zoomControl: false,
          enableCloseButton: false,
          showRoadLabels: false,
          disableDefaultUI: true
        }
      );
      // –ï—â—ë —Ä–∞–∑ —è–≤–Ω–æ (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏–π/—É—Å—Ç—Ä–æ–π—Å—Ç–≤)
      panorama.setOptions({
        disableDefaultUI: true,
        linksControl: false,
        panControl: false,
        zoomControl: false,
        addressControl: false,
        showRoadLabels: false,
        enableCloseButton: false,
      });

      mapPopup = new google.maps.Map(document.getElementById('mapCanvas'), {
        center: CITIES[selectedCity], zoom: 14
      });
      mapRoutePath = new google.maps.Polyline({
        path: [CITIES[selectedCity]],
        geodesic: true,
        strokeColor: "#f90",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      mapRoutePath.setMap(mapPopup);
      routeHistory[selectedCity] = [CITIES[selectedCity]];
      syncCity(selectedCity);
      document.querySelector('.btn-main.map').onclick = showMapPopup;
      document.getElementById('hideMapBtn').onclick = hideMapPopup;
      document.getElementById('citySelect').onchange = function(e) {
        selectedCity = e.target.value;
        localStorage.setItem("selectedCity", selectedCity);
        syncCity(selectedCity);
      };
      document.querySelectorAll('.btn-vote').forEach(btn =>
        btn.onclick = () => castVote(btn.dataset.dir)
      );
      document.querySelector('.btn-main.drive').onclick = () => drive();
      document.querySelector('.btn-main.start').onclick = async () => {
        await resetToStart(selectedCity);
      };
      document.querySelector('.btn-main.back').onclick = () => Telegram.WebApp.close();
      setInterval(updateVotes, 2000);
      setInterval(drawRouteOnMap, 3000);
      updateVotes();
      drawRouteOnMap();
    }
    function syncCity(city) {
      if (panorama) panorama.setPosition(CITIES[city]);
      if (mapPopup) mapPopup.setCenter(CITIES[city]);
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      updateVotes();
      resetTimer();
    }
    async function updateVotes() {
      const url = `${BASE_URL}/rest/v1/votes_summary?select=direction,count&city=eq.${selectedCity}&mode=eq.voting`;
      const res = await fetch(url, { headers: { apikey: API_KEY } });
      const data = await res.json();
      votes = { left: 0, straight: 0, right: 0 };
      data.forEach(v => votes[v.direction] = v.count);
      document.getElementById("voteResults").textContent =
        `–í–ª–µ–≤–æ: ${votes.left} | ‚Üë: ${votes.straight} | –í–ø—Ä–∞–≤–æ: ${votes.right}`;
      const total = votes.left + votes.straight + votes.right;
      if (total > 0 && !timerActive) startTimer();
    }
    async function castVote(dir) {
      await fetch(`${BASE_URL}/functions/v1/cast_vote-ts`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: API_KEY,
          Authorization: `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ city: selectedCity, mode: "voting", direction: dir })
      });
      updateVotes();
    }
    function startTimer() {
      timerValue = 5;
      timerActive = true;
      document.getElementById('timerLabel').style.display = "";
      document.getElementById('timerLabel').textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
      timerInterval = setInterval(() => {
        timerValue--;
        document.getElementById('timerLabel').textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
        if (timerValue <= 0) {
          drive();
        }
      }, 1000);
    }
    function resetTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerActive = false;
      timerValue = 0;
      document.getElementById('timerLabel').style.display = "none";
    }
    async function drive() {
      resetTimer();
      let maxDir = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
      if (votes[maxDir] === 0) return;
      let bestLink;
      try {
        bestLink = findBestLink(maxDir);
      } catch {
        alert("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è!");
        return;
      }
      let svService = new google.maps.StreetViewService();
      svService.getPanorama({ pano: bestLink.pano }, (data, status) => {
        if (status === google.maps.StreetViewStatus.OK) {
          const nextLatLng = data.location.latLng;
          panorama.setPosition(nextLatLng);
          panorama.setPov({ heading: bestLink.heading, pitch: 0 });
          if (!routeHistory[selectedCity]) routeHistory[selectedCity] = [];
          routeHistory[selectedCity].push({ lat: nextLatLng.lat(), lng: nextLatLng.lng() });
          drawRouteOnMap();
        }
      });
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${selectedCity}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }
    function findBestLink(dir) {
      const pov = panorama.getPov().heading;
      const links = panorama.getLinks() || [];
      const want = { straight: 0, left: 270, right: 90 }[dir];
      let best = { diff: Infinity, link: null };
      links.forEach(link => {
        let rel = (link.heading - pov + 360) % 360;
        let diff = Math.abs(rel - want);
        diff = Math.min(diff, 360 - diff);
        if (diff < best.diff) best = { diff, link };
      });
      if (!best.link) throw new Error('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞');
      return best.link;
    }
    async function resetToStart(city) {
      panorama.setPosition(CITIES[city]);
      panorama.setPov({ heading: 0, pitch: 0 });
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${city}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }
    function drawRouteOnMap() {
      if (!routeHistory[selectedCity]) return;
      mapRoutePath.setPath(routeHistory[selectedCity]);
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
    }
    function showMapPopup() {
      document.getElementById("mapPopup").style.display = "flex";
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
      google.maps.event.trigger(mapPopup, 'resize');
    }
    function hideMapPopup() {
      document.getElementById("mapPopup").style.display = "none";
    }
  </script>
</body>
</html>
