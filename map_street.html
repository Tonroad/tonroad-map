<!DOCTYPE html>
<html>
<head>
  <title>TonRoad Voting & Driving</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:30%; width:100%; }
    #street-view { height:70%; width:100%; }
    #modeLabel {
      position: absolute; top: 10px; left: 10px;
      background: green; color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
    }
    #citySelect {
      position: absolute; top: 10px; right: 10px;
      z-index: 1000; padding: 5px;
    }
    #voteResults {
      position: absolute; top: 50px; left: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000;
    }
    #radioToggle {
      position: absolute; top: 90px; right: 10px;
      z-index: 1000;
      background: orange; color: white;
      padding: 5px 10px; border-radius: 4px;
      cursor: pointer;
    }
    #goButton {
      position: absolute; bottom: 10px; right: 10px;
      background: green; color: white;
      padding: 10px 15px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
    }
    .vote-button {
      position: absolute; bottom: 10px;
      background: white; border: 1px solid #ccc;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
    }
    #voteLeft { left: 10px; }
    #voteStraight { left: 90px; }
    #voteRight { left: 180px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults">Голосов: 0</div>
  <div id="radioToggle">▶ Радио</div>
  <div id="map"></div>
  <div id="street-view"></div>
  <button id="goButton" style="display:none;">ЕХАТЬ</button>
  <button id="voteLeft" class="vote-button" style="display:none;">← Влево</button>
  <button id="voteStraight" class="vote-button" style="display:none;">↑ Прямо</button>
  <button id="voteRight" class="vote-button" style="display:none;">→ Вправо</button>

<script>
let map, streetView;
let currentVotes = { left: 0, right: 0, straight: 0 };
let mode = "free";
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true; radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { lat: 52.52, lng: 13.405 },
  Leipzig: { lat: 51.3397, lng: 12.3731 },
  Dresden: { lat: 51.0504, lng: 13.7373 },
  Novorossiysk: { lat: 44.7236, lng: 37.7689 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: cities.Berlin, zoom: 14
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });
  map.setStreetView(streetView);
}

document.getElementById("modeLabel").addEventListener("click", () => {
  if (mode === "free") {
    mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    document.getElementById("goButton").style.display = "block";
    document.getElementById("voteLeft").style.display = "block";
    document.getElementById("voteStraight").style.display = "block";
    document.getElementById("voteRight").style.display = "block";
    resetVotes();
    disableGoogleArrows(true);
  } else {
    mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    document.getElementById("goButton").style.display = "none";
    document.getElementById("voteLeft").style.display = "none";
    document.getElementById("voteStraight").style.display = "none";
    document.getElementById("voteRight").style.display = "none";
    resetVotes();
    disableGoogleArrows(false);
  }
});

document.getElementById("citySelect").addEventListener("change", e => {
  const city = cities[e.target.value];
  if (city) {
    map.setCenter(city);
    streetView.setPosition(city);
  }
});

function handleVote(dir) {
  if (mode !== "voting") return;
  currentVotes[dir]++;
  updateVoteDisplay();
}

function updateVoteDisplay() {
  document.getElementById("voteResults").textContent =
    `Влево: ${currentVotes.left} | Прямо: ${currentVotes.straight} | Вправо: ${currentVotes.right}`;
}

function resetVotes() {
  currentVotes = { left: 0, right: 0, straight: 0 };
  updateVoteDisplay();
}

function disableGoogleArrows(disable) {
  streetView.setOptions({ disableDefaultUI: disable });
}

document.getElementById("voteLeft").addEventListener("click", () => handleVote("left"));
document.getElementById("voteStraight").addEventListener("click", () => handleVote("straight"));
document.getElementById("voteRight").addEventListener("click", () => handleVote("right"));

document.getElementById("goButton").addEventListener("click", () => {
  const maxDir = Object.keys(currentVotes).reduce((a,b) => currentVotes[a]>currentVotes[b]?a:b);
  const total = currentVotes.left + currentVotes.straight + currentVotes.right;

  if (total === 0) {
    showMessage("Нет голосов для движения");
    return;
  }

  movePanorama(maxDir);
  showMessage(`Вы поехали как большинство (${maxDir})`);
  resetVotes();
});

function movePanorama(dir) {
  let pov = streetView.getPov();
  if (dir === "left") pov.heading -= 30;
  if (dir === "right") pov.heading += 30;
  streetView.setPov(pov);
}

function showMessage(msg) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position = "absolute";
  el.style.top = "80px";
  el.style.left = "10px";
  el.style.background = "red";
  el.style.color = "white";
  el.style.padding = "5px 10px";
  el.style.zIndex = 1000;
  el.style.borderRadius = "4px";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

window.onload = () => {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
  } catch(e){
    console.error("Ошибка Telegram SDK", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
