<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button onclick="vote('left')">←</button>
    <button onclick="vote('straight')">↑</button>
    <button onclick="vote('right')">→</button>
    <button onclick="drive()">ЕХАТЬ</button>
  </div>

  <script>
    const SUPABASE_URL = "https://qsdaooxwzinologyheyv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const CITY = "Novorossiysk";
    const MODE = "default";
    let map, panorama, currentPosition = null;

    async function loadCurrentPosition() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/current_position?city=eq.${CITY}&select=lat,lng,heading&order=updated_at.desc&limit=1`, {
        headers: {
          apiKey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        }
      });
      const data = await res.json();
      if (data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lng),
          heading: parseFloat(data[0].heading)
        };
      } else {
        return { lat: 44.72395, lng: 37.67878, heading: 0 };
      }
    }

    async function initMap() {
      currentPosition = await loadCurrentPosition();
      const sv = new google.maps.StreetViewService();
      panorama = new google.maps.StreetViewPanorama(document.getElementById("map"), {
        position: currentPosition,
        pov: { heading: currentPosition.heading, pitch: 0 },
        visible: true
      });
      map = new google.maps.Map(document.createElement("div")); // нужен объект карты для геокодера
    }

    async function vote(direction) {
      await fetch(`${SUPABASE_URL}/rest/v1/votes_summary`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apiKey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({
          city: CITY,
          mode: MODE,
          direction: direction,
          count: 1
        })
      });
    }

    async function drive() {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/votes_summary?city=eq.${CITY}&mode=eq.${MODE}`, {
        headers: {
          apiKey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        }
      });
      const votes = await response.json();
      let max = 0, selected = "straight";
      votes.forEach(v => {
        if (v.count > max) {
          max = v.count;
          selected = v.direction;
        }
      });

      const currentLoc = panorama.getLocation();
      const next = getNextPosition(currentLoc.latLng, panorama.getPov().heading, selected);
      if (!next) return alert("Место недоступно.");

      panorama.setPosition(next);
      panorama.setPov({ heading: next.heading, pitch: 0 });

      // Сохраняем новую позицию
      await fetch(`${SUPABASE_URL}/rest/v1/current_position`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apiKey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({
          city: CITY,
          lat: next.lat,
          lng: next.lng,
          heading: next.heading
        })
      });

      // Обнуляем голоса
      await fetch(`${SUPABASE_URL}/functions/v1/bright-endpoint`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          city: CITY,
          mode: MODE
        })
      });
    }

    function getNextPosition(latlng, heading, direction) {
      let angle = heading;
      if (direction === "left") angle -= 90;
      if (direction === "right") angle += 90;

      const distance = 0.0003; // прибл. 30м
      const rad = angle * Math.PI / 180;
      const dx = distance * Math.cos(rad);
      const dy = distance * Math.sin(rad);

      return {
        lat: latlng.lat() + dy,
        lng: latlng.lng() + dx,
        heading: angle % 360
      };
    }

    window.onload = initMap;
  </script>
</body>
</html>
