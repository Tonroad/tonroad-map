<!DOCTYPE html>
<html>
<head>
  <title>TonRoad</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: green;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      cursor: pointer;
    }
    #citySelect {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1000;
      padding: 5px;
    }
    #radioToggle {
      position: absolute;
      top: 50px; right: 10px;
      z-index: 1000;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #voteInfo, #driveControls {
      position: absolute;
      bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      display: none;
    }
    #driveVotesStatus {
      margin-top: 5px;
    }
    .dirBtn {
      margin: 5px;
      padding: 5px 10px;
      background: #4285F4;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосование: <span id="voteStatus">0</span></div>
  <div id="driveControls">
    <div>
      <button class="dirBtn" data-dir="left">⬅ Влево</button>
      <button class="dirBtn" data-dir="straight">⬆ Прямо</button>
      <button class="dirBtn" data-dir="right">➡ Вправо</button>
    </div>
    <div id="driveVotesStatus">Направлений голосов пока нет</div>
  </div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteState = { mode: "free", votes: {}, timer: null, driveVotes: {} };
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { position: { lat: 52.5200, lng: 13.4050 }, votes: 0 },
  Leipzig: { position: { lat: 51.3397, lng: 12.3731 }, votes: 0 },
  Dresden: { position: { lat: 51.0504, lng: 13.7373 }, votes: 0 },
  Novorossiysk: { position: { lat: 44.7236, lng: 37.7689 }, votes: 0 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: cities.Berlin.position
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin.position,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(streetView);

  Object.entries(cities).forEach(([name, data]) => {
    const marker = new google.maps.Marker({
      position: data.position,
      map: map,
      title: name
    });
    data.marker = marker;

    marker.addListener("click", () => {
      if (voteState.mode === "voting") {
        registerVote(name);
      }
      streetView.setPosition(data.position);
    });
  });
}

function registerVote(cityName) {
  if (voteState.mode !== "voting") return;

  const userId = window.telegramUserId || "unknown";
  if (voteState.votes[userId]) {
    alert("Ты уже голосовал!");
    return;
  }

  voteState.votes[userId] = cityName;
  cities[cityName].votes++;
  updateVoteStatus();
}

function updateVoteStatus() {
  document.getElementById("voteStatus").textContent =
    Object.entries(cities).map(([n,c]) => `${n}:${c.votes}`).join(" | ");
}

function switchMode() {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    document.getElementById("voteInfo").style.display = "block";
    document.getElementById("driveControls").style.display = "none";
    resetVotes();
  } else if (voteState.mode === "voting") {
    voteState.mode = "drivevote";
    document.getElementById("modeLabel").textContent = "Режим: Руление";
    document.getElementById("modeLabel").style.background = "orange";
    document.getElementById("voteInfo").style.display = "none";
    document.getElementById("driveControls").style.display = "block";
    resetVotes();
    startDriveVoting();
  } else {
    voteState.mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    document.getElementById("voteInfo").style.display = "none";
    document.getElementById("driveControls").style.display = "none";
    clearInterval(voteState.timer);
  }
}

function resetVotes() {
  voteState.votes = {};
  Object.values(cities).forEach(c => c.votes = 0);
  voteState.driveVotes = {};
  document.getElementById("driveVotesStatus").textContent = "Направлений голосов пока нет";
}

document.getElementById("modeLabel").addEventListener("click", switchMode);

document.querySelectorAll(".dirBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (voteState.mode !== "drivevote") return;
    const userId = window.telegramUserId || "unknown";
    if (voteState.driveVotes[userId]) return;
    voteState.driveVotes[userId] = btn.dataset.dir;
    updateDriveVotesStatus();
  });
});

function updateDriveVotesStatus() {
  const tally = { left:0, right:0, straight:0 };
  Object.values(voteState.driveVotes).forEach(v => {
    if (tally[v] !== undefined) tally[v]++;
  });
  document.getElementById("driveVotesStatus").textContent = 
    `⬅:${tally.left} | ⬆:${tally.straight} | ➡:${tally.right}`;
}

function startDriveVoting() {
  if (voteState.timer) clearInterval(voteState.timer);
  voteState.timer = setInterval(() => {
    const tally = { left:0, right:0, straight:0 };
    Object.values(voteState.driveVotes).forEach(v => {
      if (tally[v] !== undefined) tally[v]++;
    });

    let dir = "straight";
    let max = 0;
    for (let [d,count] of Object.entries(tally)) {
      if (count > max) {
        max = count;
        dir = d;
      }
    }
    moveStreetView(dir);
    voteState.driveVotes = {}; // reset votes
    updateDriveVotesStatus();
  }, 5000);
}

function moveStreetView(direction) {
  const svService = new google.maps.StreetViewService();
  svService.getPanorama({location:streetView.getPosition(), radius:50}, (data, status) => {
    if (status === google.maps.StreetViewStatus.OK) {
      const links = data.links;
      let bestLink = null;

      if (links && links.length > 0) {
        if (direction === "left") {
          bestLink = links.reduce((prev, curr) => curr.heading < prev.heading ? curr : prev, links[0]);
        } else if (direction === "right") {
          bestLink = links.reduce((prev, curr) => curr.heading > prev.heading ? curr : prev, links[0]);
        } else {
          bestLink = links[0]; // прямо
        }

        if (bestLink) {
          streetView.setPano(bestLink.pano);
        }
      }
    }
  });
}

document.getElementById("citySelect").addEventListener("change", e => {
  const cityName = e.target.value;
  const city = cities[cityName];
  if (city) {
    map.setCenter(city.position);
    streetView.setPosition(city.position);
  }
});

document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("Ошибка Telegram SDK", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
