<!DOCTYPE html>
<html>
<head>
  <title>TonRoad</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:33%; width:100%; }
    #street-view { height:67%; width:100%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      cursor: pointer;
    }
    #citySelect {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1000;
      padding: 5px;
    }
    #radioToggle {
      position: absolute;
      top: 50px; right: 10px;
      z-index: 1000;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #voteInfo {
      position: absolute;
      top: 50px; left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
    }
    #resultMessage {
      position: absolute;
      top: 90px; left: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      display: none;
    }
    #voteButtons {
      position: absolute;
      bottom: 10px; left: 10px;
      z-index: 1000;
    }
    .dirBtn {
      margin: 2px;
      padding: 5px 10px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Голосование</div>
  <select id="citySelect">
    <option value="Novorossiysk">Новороссийск</option>
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосов: ← 0 | ↑ 0 | → 0</div>
  <div id="resultMessage"></div>
  <div id="voteButtons">
    <button class="dirBtn" data-dir="left">⬅ Влево</button>
    <button class="dirBtn" data-dir="straight">⬆ Прямо</button>
    <button class="dirBtn" data-dir="right">➡ Вправо</button>
  </div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Novorossiysk: { lat: 44.7236, lng: 37.7689 },
  Berlin: { lat: 52.5200, lng: 13.4050 },
  Leipzig: { lat: 51.3397, lng: 12.3731 },
  Dresden: { lat: 51.0504, lng: 13.7373 }
};

let votes = { left: 0, straight: 0, right: 0 };
let majorityDirection = null;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: cities.Novorossiysk,
    zoom: 14
  });
  streetView = new google.maps.StreetViewPanorama(
    document.getElementById("street-view"), {
      position: cities.Novorossiysk,
      pov: { heading: 0, pitch: 0 },
      visible: true
    }
  );
  map.setStreetView(streetView);
}

document.getElementById("citySelect").addEventListener("change", e => {
  const city = e.target.value;
  const pos = cities[city];
  map.setCenter(pos);
  streetView.setPosition(pos);
  streetView.setPov({ heading: 0, pitch: 0 });
});

document.querySelectorAll(".dirBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const dir = btn.dataset.dir;
    votes[dir]++;
    updateVotes();
  });
});

function updateVotes() {
  document.getElementById("voteInfo").textContent =
    `Голосов: ← ${votes.left} | ↑ ${votes.straight} | → ${votes.right}`;
  let maxVote = Math.max(votes.left, votes.straight, votes.right);
  if (maxVote === votes.left) majorityDirection = "left";
  if (maxVote === votes.straight) majorityDirection = "straight";
  if (maxVote === votes.right) majorityDirection = "right";
}

streetView.addListener("pov_changed", () => {
  const pov = streetView.getPov();
  let currentDir = null;
  if (pov.heading >= -20 && pov.heading <= 20) currentDir = "straight";
  if (pov.heading > 20) currentDir = "right";
  if (pov.heading < -20) currentDir = "left";

  if (majorityDirection && currentDir) {
    if (currentDir === majorityDirection) {
      showResult("✅ Вы поехали туда, куда выбрало большинство!");
    } else {
      showResult("❌ Вы не туда повернули!");
    }
  }
});

function showResult(text) {
  const msg = document.getElementById("resultMessage");
  msg.textContent = text;
  msg.style.display = "block";
  setTimeout(() => { msg.style.display = "none"; }, 3000);
}

document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("Telegram SDK error", e);
  }
};
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap"
  async defer></script>
</body>
</html>
