<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    #map { height:30vh; width:100%; }
    #street-view { height:70vh; width:100%; position:relative; }
    .street-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1001; background:rgba(255,255,255,0); display:none; }
    .mode-label, #citySelect, #voteResults, #driveButton, #backButton, #position-info { position:absolute; z-index:1002; }
    .mode-label { top:10px; left:10px; background:red; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; }
    #citySelect { top:10px; right:10px; padding:5px; }
    #voteResults { top:50px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #driveButton { bottom:100px; right:10px; background:green; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    #backButton { bottom:20px; right:10px; background:orange; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    .vote-buttons { position:absolute; bottom:20px; left:10px; z-index:1002; }
    .vote-buttons button { margin-right:5px; padding:8px 12px; }
    #position-info { bottom:70px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>
</head>
<body>
  <div id="modeLabel" class="mode-label">Режим: Голосование</div>
  <select id="citySelect" disabled>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults">Влево: 0 | Прямо: 0 | Вправо: 0</div>
  <div id="position-info">lat: ..., lng: ..., heading: ...</div>
  <button id="driveButton">ЕХАТЬ</button>
  <button id="backButton">← Вернуться на карту</button>
  <div id="map"></div>
  <div id="street-view"><div id="streetOverlay" class="street-overlay"></div></div>
  <div class="vote-buttons">
    <button data-dir="left">← Влево</button>
    <button data-dir="straight">↑ Прямо</button>
    <button data-dir="right">→ Вправо</button>
  </div>

  <script>
    const supabase = supabase.createClient(
      "https://qsdaooxywznloogyheyu.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do"
    );

    let voted = false;
    let panorama;
    const city = 'Novorossiysk';
    const mode = 'voting';

    async function loadVotes() {
      const { data, error } = await supabase
        .from('votes_summary')
        .select('direction, count')
        .eq('city', city)
        .eq('mode', mode);

      if (!error) {
        let counts = { left: 0, straight: 0, right: 0 };
        data.forEach(v => counts[v.direction] = v.count);
        document.getElementById("voteResults").textContent = `Влево: ${counts.left} | Прямо: ${counts.straight} | Вправо: ${counts.right}`;
      }
    }

    async function castVote(direction) {
      if (voted) return;
      voted = true;
      await supabase.rpc('cast_vote', { in_city: city, in_mode: mode, in_direction: direction });
      loadVotes();
    }

    async function resetVotes() {
      await supabase.rpc('reset_votes', { in_city: city, in_mode: mode });
    }

    async function savePosition(position) {
      await supabase
        .from('current_position')
        .upsert({ city, ...position });
    }

    async function loadPosition() {
      const { data, error } = await supabase
        .from('current_position')
        .select('lat, lng, heading')
        .eq('city', city)
        .single();

      if (!error && data) {
        return data;
      }
      return { lat: 44.7235, lng: 37.7685, heading: 0 };
    }

    async function drive() {
      const votes = await supabase
        .from('votes_summary')
        .select('*')
        .eq('city', city)
        .eq('mode', mode);
      
      if (votes.error || votes.data.length === 0) return;

      let maxDir = 'straight';
      let maxVal = -1;
      for (let v of votes.data) {
        if (v.count > maxVal) {
          maxVal = v.count;
          maxDir = v.direction;
        }
      }

      const links = panorama.getLinks();
      const pov = panorama.getPov().heading;
      const desired = { left: 270, straight: 0, right: 90 }[maxDir];

      let bestLink = null;
      let bestDiff = Infinity;
      links.forEach(link => {
        let rel = (link.heading - pov + 360) % 360;
        let diff = Math.abs(rel - desired);
        diff = Math.min(diff, 360 - diff);
        if (diff < bestDiff) {
          bestDiff = diff;
          bestLink = link;
        }
      });

      if (bestLink) {
        panorama.setPov({ heading: bestLink.heading, pitch: 0 });
        setTimeout(() => panorama.setPano(bestLink.pano), 500);
        savePosition({ lat: panorama.getPosition().lat(), lng: panorama.getPosition().lng(), heading: bestLink.heading });
      }

      await resetVotes();
      voted = false;
    }

    function updatePositionDisplay() {
      const pos = panorama.getPosition();
      const heading = panorama.getPov().heading;
      document.getElementById('position-info').textContent = `lat: ${pos.lat().toFixed(5)}, lng: ${pos.lng().toFixed(5)}, heading: ${heading.toFixed(1)}`;
    }

    async function initMap() {
      const initial = await loadPosition();
      panorama = new google.maps.StreetViewPanorama(document.getElementById('street-view'), {
        position: initial,
        pov: { heading: initial.heading, pitch: 0 },
        visible: true
      });
      const map = new google.maps.Map(document.getElementById('map'), {
        center: initial, zoom: 14, streetViewControl: false
      });
      map.setStreetView(panorama);
      updatePositionDisplay();

      panorama.addListener('position_changed', updatePositionDisplay);
      panorama.addListener('pov_changed', updatePositionDisplay);
    }

    document.addEventListener("DOMContentLoaded", () => {
      Telegram.WebApp.ready();

      initMap();
      loadVotes();
      setInterval(loadVotes, 5000);
      setInterval(async () => {
        const pos = await loadPosition();
        if (panorama) {
          panorama.setPosition(pos);
          panorama.setPov({ heading: pos.heading, pitch: 0 });
        }
      }, 5000);

      document.querySelectorAll(".vote-buttons button").forEach(btn => {
        btn.addEventListener("click", () => castVote(btn.dataset.dir));
      });

      document.getElementById("driveButton").addEventListener("click", () => drive());
      document.getElementById("backButton").addEventListener("click", () => window.location.href = "map.html");
    });
  </script>
</body>
</html>
