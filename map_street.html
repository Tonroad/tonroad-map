<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #2c3e50;
      color: #ecf0f1;
    }
    #map { height: 30vh; width: 100%; }
    #street-view { height: 70vh; width: 100%; position: relative; }
    .overlay, .mode-label, #voteResults, #citySelect, #driveButton, #backButton, .vote-buttons {
      position: absolute;
      z-index: 1001;
    }
    .mode-label {
      top: 10px; left: 10px;
      background: red; padding: 5px 10px;
      border-radius: 5px; cursor: pointer;
    }
    #voteResults {
      top: 50px; left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 5px 10px; border-radius: 5px;
    }
    #citySelect { top: 10px; right: 10px; }
    #driveButton, #backButton {
      bottom: 20px; padding: 10px 15px;
      border-radius: 4px; cursor: pointer;
    }
    #driveButton { right: 10px; background: green; color: white; }
    #backButton { right: 140px; background: orange; color: white; }
    .vote-buttons {
      bottom: 80px; left: 10px;
    }
    .vote-buttons button {
      margin-right: 5px; padding: 8px 12px;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initApp" async defer></script>
</head>
<body>
  <div id="modeLabel" class="mode-label">Режим: Голосование</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults">Влево: 0 | Прямо: 0 | Вправо: 0</div>
  <div id="map"></div>
  <div id="street-view"></div>
  <div class="vote-buttons">
    <button data-dir="left">← Влево</button>
    <button data-dir="straight">↑ Прямо</button>
    <button data-dir="right">→ Вправо</button>
  </div>
  <button id="driveButton">ЕХАТЬ</button>
  <button id="backButton">← Вернуться</button>

  <script>
    const apiBase = "https://c119a7ee-1920-4b1d-892f-a72ed2bcd086--00-3vv2w0fvor7to.kirk.replit.dev/api/Votes";

    const cities = {
      Berlin: { lat: 52.52, lng: 13.405 },
      Leipzig: { lat: 51.3397, lng: 12.3731 },
      Dresden: { lat: 51.0504, lng: 13.7373 },
      Novorossiysk: { lat: 44.7236, lng: 37.7689 }
    };

    let currentCity = "Berlin";
    let currentMode = "voting";
    let panorama, voteCounts = { left: 0, straight: 0, right: 0 };

    function updateVoteDisplay() {
      document.getElementById("voteResults").textContent =
        `Влево: ${voteCounts.left} | Прямо: ${voteCounts.straight} | Вправо: ${voteCounts.right}`;
    }

    async function sendVote(direction) {
      try {
        await fetch(`${apiBase}/${currentCity}/${currentMode}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ direction })
        });
        voteCounts[direction]++;
        updateVoteDisplay();
      } catch (e) {
        alert("Ошибка отправки: " + e);
      }
    }

    async function loadVotes() {
      try {
        const res = await fetch(`${apiBase}/${currentCity}/${currentMode}`);
        const data = await res.json();
        voteCounts = { left: 0, straight: 0, right: 0 };
        data.forEach(item => voteCounts[item.direction] = item.count);
        updateVoteDisplay();
      } catch (e) {
        console.error("Ошибка загрузки голосов", e);
      }
    }

    function moveInDirection(direction) {
      const links = panorama.getLinks();
      const currentHeading = panorama.getPov().heading;
      const angles = { straight: 0, left: 270, right: 90 };
      const desired = angles[direction];
      let best = null, minDiff = Infinity;

      for (const link of links) {
        const rel = (link.heading - currentHeading + 360) % 360;
        let diff = Math.abs(rel - desired);
        diff = Math.min(diff, 360 - diff);
        if (diff < minDiff) {
          minDiff = diff;
          best = link;
        }
      }

      if (best) {
        panorama.setPov({ heading: best.heading, pitch: 0 });
        setTimeout(() => panorama.setPano(best.pano), 500);
      } else {
        alert("Нет подходящего поворота");
      }
    }

    function initApp() {
      Telegram.WebApp.ready();

      const map = new google.maps.Map(document.getElementById("map"), {
        center: cities[currentCity],
        zoom: 14
      });

      panorama = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
        position: cities[currentCity],
        pov: { heading: 0, pitch: 0 },
        visible: true
      });

      map.setStreetView(panorama);

      document.querySelectorAll('.vote-buttons button').forEach(btn => {
        btn.addEventListener('click', () => {
          const dir = btn.dataset.dir;
          sendVote(dir);
        });
      });

      document.getElementById("citySelect").addEventListener("change", async e => {
        currentCity = e.target.value;
        panorama.setPosition(cities[currentCity]);
        map.setCenter(cities[currentCity]);
        await loadVotes();
      });

      document.getElementById("modeLabel").addEventListener("click", () => {
        currentMode = currentMode === "voting" ? "free" : "voting";
        document.getElementById("modeLabel").textContent = `Режим: ${currentMode === "voting" ? "Голосование" : "Свободная езда"}`;
        document.getElementById("modeLabel").style.background = currentMode === "voting" ? "red" : "green";
        loadVotes();
      });

      document.getElementById("driveButton").addEventListener("click", () => {
        const maxDir = Object.keys(voteCounts).reduce((a, b) => voteCounts[a] > voteCounts[b] ? a : b);
        moveInDirection(maxDir);
        voteCounts = { left: 0, straight: 0, right: 0 };
        updateVoteDisplay();
      });

      document.getElementById("backButton").addEventListener("click", () => {
        window.location.href = "map.html";
      });

      loadVotes();
    }
  </script>
</body>
</html>
