<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TonRoad Street View</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #voteStatus, #coordinatesDisplay {
      background: red;
      color: white;
      padding: 4px;
    }
    #coordinatesDisplay {
      background: #eee;
      color: #000;
    }
    #streetView {
      position: relative;
      height: 50%;
      overflow: hidden;
    }
    #map {
      height: 50%;
    }
    #voteButtons {
      position: absolute;
      bottom: 10px;
      left: 10px;
    }
    #voteButtons button {
      margin: 2px;
    }
    #driveButton {
      position: absolute;
      bottom: 10px;
      right: 10px;
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
</head>
<body>
  <div id="voteStatus">Загрузка...</div>
  <div id="coordinatesDisplay">Координаты:</div>
  <div id="map"></div>
  <div id="streetView"></div>
  <div id="voteButtons">
    <button onclick="castVote('left')">← Влево</button>
    <button onclick="castVote('straight')">↑ Прямо</button>
    <button onclick="castVote('right')">→ Вправо</button>
  </div>
  <div id="driveButton">
    <button onclick="moveCar()">ЕХАТЬ</button>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://qsdaoowzxlooyehy.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do'
    );

    let panorama;
    let map;

    async function loadPosition() {
      const { data, error } = await supabase
        .from('current_position')
        .select('*')
        .eq('city', 'Novorossiysk')
        .single();

      if (error || !data) {
        document.getElementById('voteStatus').innerText = 'Ошибка загрузки позиции';
        return;
      }

      const { lat, lng } = data;
      document.getElementById('coordinatesDisplay').innerText = `Координаты: ${lat}, ${lng}`;

      const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
      map = new google.maps.Map(document.getElementById("map"), {
        center: position,
        zoom: 15,
      });

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("streetView"),
        {
          position: position,
          pov: { heading: 165, pitch: 0 },
          zoom: 1,
        }
      );
      map.setStreetView(panorama);
    }

    async function castVote(direction) {
      const { error } = await supabase
        .from('votes_summary')
        .update({ count: supabase.rpc('increment_vote', { direction_param: direction }) })
        .eq('direction', direction)
        .eq('city', 'Novorossiysk')
        .eq('mode', 'vote');

      if (!error) {
        document.getElementById('voteStatus').innerText = `Голос за ${direction.toUpperCase()} отправлен!`;
      } else {
        document.getElementById('voteStatus').innerText = 'Ошибка голосования';
      }
    }

    async function moveCar() {
      // получить направление с наибольшим числом голосов
      const { data, error } = await supabase
        .from('votes_summary')
        .select('direction, count')
        .eq('city', 'Novorossiysk')
        .eq('mode', 'vote')
        .order('count', { ascending: false })
        .limit(1)
        .single();

      if (error || !data) {
        document.getElementById('voteStatus').innerText = 'Ошибка движения';
        return;
      }

      const nextLat = panorama.getPosition().lat() + 0.0001;
      const nextLng = panorama.getPosition().lng();

      await supabase
        .from('current_position')
        .update({ lat: nextLat, lng: nextLng })
        .eq('city', 'Novorossiysk');

      document.getElementById('coordinatesDisplay').innerText = `Координаты: ${nextLat}, ${nextLng}`;

      panorama.setPosition({ lat: nextLat, lng: nextLng });
      map.setCenter({ lat: nextLat, lng: nextLng });

      // обнуление голосов
      await supabase
        .from('votes_summary')
        .update({ count: 0 })
        .eq('city', 'Novorossiysk')
        .eq('mode', 'vote');

      document.getElementById('voteStatus').innerText = 'Машина поехала';
    }

    loadPosition();
  </script>
</body>
</html>
