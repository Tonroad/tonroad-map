<!DOCTYPE html>
<html>
<head>
  <title>TonRoad</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #topBar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 128, 0, 0.8);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 10px;
      z-index: 1000;
    }
    #modeBtn {
      cursor: pointer;
    }
    #voteStatus {
      margin-left: 10px;
      font-size: 14px;
    }
    #citySelect {
      margin-left: 10px;
      padding: 3px;
    }
    .dirBtn {
      margin: 5px;
      padding: 5px 10px;
      background: #4285F4;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    #radioBtn {
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="topBar">
    <span id="modeBtn">Режим: Свободная езда</span>
    <select id="citySelect">
      <option value="Berlin">Берлин</option>
      <option value="Leipzig">Лейпциг</option>
      <option value="Dresden">Дрезден</option>
      <option value="Novorossiysk">Новороссийск</option>
    </select>
    <button id="radioBtn">▶ Радио</button>
    <span id="voteStatus" style="display:none;">Голоса: ←0 ↑0 →0</span>
  </div>

  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteState = {
  mode: "free",
  votes: { left: 0, straight: 0, right: 0 },
  timer: null
};
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { position: { lat: 52.5200, lng: 13.4050 } },
  Leipzig: { position: { lat: 51.3397, lng: 12.3731 } },
  Dresden: { position: { lat: 51.0504, lng: 13.7373 } },
  Novorossiysk: { position: { lat: 44.7236, lng: 37.7689 } }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: cities.Berlin.position
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin.position,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(streetView);
}

// переключение режима
document.getElementById("modeBtn").addEventListener("click", () => {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    document.getElementById("modeBtn").textContent = "Режим: Голосование";
    document.getElementById("topBar").style.background = "red";
    document.getElementById("voteStatus").style.display = "inline";
    startVotingTimer();
  } else {
    voteState.mode = "free";
    document.getElementById("modeBtn").textContent = "Режим: Свободная езда";
    document.getElementById("topBar").style.background = "green";
    document.getElementById("voteStatus").style.display = "none";
    clearInterval(voteState.timer);
  }
});

// радио
document.getElementById("radioBtn").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioBtn").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioBtn").textContent = "⏸ Радио";
  }
});

// город
document.getElementById("citySelect").addEventListener("change", e => {
  const city = e.target.value;
  const pos = cities[city].position;
  map.setCenter(pos);
  streetView.setPosition(pos);
  streetView.setPov({ heading: 0, pitch: 0 });
});

// слушаем клики в панораме
window.addEventListener("click", e => {
  if (voteState.mode !== "voting") return;
  const arrow = e.target.closest(".widget-scene-canvas");
  if (arrow) {
    // в режиме голосования фиксируем голоса по направлениям
    const x = e.clientX;
    const screenCenter = window.innerWidth / 2;
    if (x < screenCenter - 100) {
      voteState.votes.left++;
    } else if (x > screenCenter + 100) {
      voteState.votes.right++;
    } else {
      voteState.votes.straight++;
    }
    updateVoteDisplay();
  }
});

// показывать голоса
function updateVoteDisplay() {
  document.getElementById("voteStatus").textContent =
    `Голоса: ←${voteState.votes.left} ↑${voteState.votes.straight} →${voteState.votes.right}`;
}

// каждые 5 сек считаем
function startVotingTimer() {
  voteState.timer = setInterval(() => {
    let max = Math.max(voteState.votes.left, voteState.votes.right, voteState.votes.straight);
    let dir = "straight";
    if (voteState.votes.left === max) dir = "left";
    if (voteState.votes.right === max) dir = "right";

    let pov = streetView.getPov();
    if (dir === "left") pov.heading -= 30;
    if (dir === "right") pov.heading += 30;
    streetView.setPov(pov);

    voteState.votes = { left: 0, straight: 0, right: 0 }; // обнуляем
    updateVoteDisplay();
  }, 5000);
}

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("Ошибка Telegram SDK", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
