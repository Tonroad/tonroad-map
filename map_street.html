<!DOCTYPE html>
<html>
<head>
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #2c3e50;
    }
    #map, #pano {
      height: 50%;
    }
    #modeLabel {
      color: red;
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 10;
    }
    #voteCounts {
      position: absolute;
      top: 10px;
      left: 160px;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
    }
    #citySelect {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    .vote-button {
      position: absolute;
      bottom: 10px;
      width: 80px;
      height: 30px;
      font-size: 16px;
      z-index: 10;
    }
    #leftBtn { left: 10px; }
    #straightBtn { left: 100px; }
    #rightBtn { left: 190px; }
    #exitBtn {
      position: absolute;
      bottom: 50px;
      right: 10px;
      background-color: green;
      color: white;
      z-index: 10;
    }
    #backToMapBtn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="modeLabel">Режим: <span id="mode">Голосование</span></div>
  <div id="voteCounts">Влево: <span id="leftVotes">0</span> | Прямо: <span id="straightVotes">0</span> | Вправо: <span id="rightVotes">0</span></div>
  <select id="citySelect">
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="map"></div>
  <div id="pano"></div>
  <button class="vote-button" id="leftBtn">← Влево</button>
  <button class="vote-button" id="straightBtn">↑ Прямо</button>
  <button class="vote-button" id="rightBtn">→ Вправо</button>
  <button id="exitBtn">ЕХАТЬ</button>
  <button id="backToMapBtn">← Вернуться на карту</button>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const supabaseUrl = 'https://qsdaoowxznooghevyuql.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do';

    const tg = window.Telegram.WebApp;
    tg.expand();

    let map, panorama, currentPosition = { lat: 44.7236, lng: 37.7689, heading: 0 }, city = 'Novorossiysk';
    const voteCounts = { left: 0, straight: 0, right: 0 };

    document.getElementById('citySelect').value = city;

    async function fetchCurrentPosition() {
      const res = await fetch(`${supabaseUrl}/rest/v1/current_position?city=eq.${city}&select=lat,lng,heading&order=updated_at.desc&limit=1`, {
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`
        }
      });
      const data = await res.json();
      if (data.length > 0) currentPosition = data[0];
    }

    function updateVoteDisplay() {
      document.getElementById('leftVotes').textContent = voteCounts.left;
      document.getElementById('straightVotes').textContent = voteCounts.straight;
      document.getElementById('rightVotes').textContent = voteCounts.right;
    }

    async function castVote(direction) {
      voteCounts[direction]++;
      updateVoteDisplay();
      await fetch(`${supabaseUrl}/rest/v1/votes_summary`, {
        method: 'POST',
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          city: city,
          mode: 'vote',
          direction: direction,
          count: 1
        })
      });
    }

    async function resetVotes() {
      await fetch(`${supabaseUrl}/rest/v1/rpc/reset_votes`, {
        method: 'POST',
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ city: city, mode: 'vote' })
      });
    }

    async function saveCurrentPositionToSupabase() {
      await fetch(`${supabaseUrl}/rest/v1/current_position`, {
        method: 'POST',
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          city: city,
          lat: currentPosition.lat,
          lng: currentPosition.lng,
          heading: currentPosition.heading
        })
      });
    }

    function drive() {
      const maxVotes = Math.max(voteCounts.left, voteCounts.straight, voteCounts.right);
      if (maxVotes === 0) return;
      let direction = 'straight';
      if (voteCounts.left === maxVotes) direction = 'left';
      if (voteCounts.right === maxVotes) direction = 'right';

      if (direction === 'left') currentPosition.heading -= 90;
      if (direction === 'right') currentPosition.heading += 90;
      if (direction === 'straight') {
        const rad = currentPosition.heading * (Math.PI / 180);
        currentPosition.lat += 0.0003 * Math.cos(rad);
        currentPosition.lng += 0.0003 * Math.sin(rad);
      }

      panorama.setPosition({ lat: currentPosition.lat, lng: currentPosition.lng });
      panorama.setPov({ heading: currentPosition.heading, pitch: 0 });

      voteCounts.left = 0;
      voteCounts.straight = 0;
      voteCounts.right = 0;
      updateVoteDisplay();

      saveCurrentPositionToSupabase();
      resetVotes();
    }

    async function init() {
      await fetchCurrentPosition();
      map = new google.maps.Map(document.getElementById("map"), {
        center: currentPosition,
        zoom: 14
      });

      panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
        position: currentPosition,
        pov: {
          heading: currentPosition.heading,
          pitch: 0,
        },
        visible: true,
      });

      map.setStreetView(panorama);
    }

    window.onload = () => {
      init();
      document.getElementById('leftBtn').onclick = () => castVote('left');
      document.getElementById('straightBtn').onclick = () => castVote('straight');
      document.getElementById('rightBtn').onclick = () => castVote('right');
      document.getElementById('exitBtn').onclick = () => drive();
    };
  </script>
</body>
</html>
