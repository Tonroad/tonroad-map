<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>TonRoad Street View</title>
  <style>
    html, body { margin: 0; height: 100%; font-family: Arial, sans-serif; }
    #voteResults, #coordinates { padding: 4px; color: #fff; background: red; font-size: 14px; }
    #mapContainer { height: 50%; }
    #streetView { height: 50%; background: #eee; position: relative; }
    #voteButtons button { margin: 4px; }
    #coordinates { background: #333; margin-top: 4px; }
  </style>
</head>
<body>
  <div id="voteResults">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="coordinates"></div>
  <div id="mapContainer"><div id="map"></div></div>
  <div id="streetView"></div>
  <div id="voteButtons">
    <button onclick="castVote('left')">‚¨Ö –í–ª–µ–≤–æ</button>
    <button onclick="castVote('straight')">‚Üë –ü—Ä—è–º–æ</button>
    <button onclick="castVote('right')">‚û° –í–ø—Ä–∞–≤–æ</button>
    <button onclick="moveCar()">üöó –ï–•–ê–¢–¨</button>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  <script>
    const SUPABASE_URL = "https://qsdaoowzxlooyehy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";

    let map, streetView, currentLat = 44.72317, currentLng = 37.76823;

    async function castVote(direction) {
      await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_vote`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({ p_city: "Novorossiysk", p_direction: direction, p_mode: "vote" })
      });
      updateVotesDisplay();
    }

    async function updateVotesDisplay() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/votes_summary?city=eq.Novorossiysk&mode=eq.vote`, {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      const data = await res.json();
      const counts = { left: 0, straight: 0, right: 0 };
      data.forEach(row => counts[row.direction] = row.count);
      document.getElementById("voteResults").innerText =
        `‚¨Ö ${counts.left} | ‚Üë ${counts.straight} | ‚û° ${counts.right}`;

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å Supabase
      const coordRes = await fetch(`${SUPABASE_URL}/rest/v1/current_position?city=eq.Novorossiysk&mode=eq.vote`, {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      const coordData = await coordRes.json();
      if (coordData.length > 0) {
        const { lat, lng } = coordData[0];
        if (lat !== currentLat || lng !== currentLng) {
          currentLat = lat;
          currentLng = lng;
          streetView.setPosition({ lat, lng });
        }
        document.getElementById("coordinates").innerText =
          `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      }
    }

    async function moveCar() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_vote_count`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({ city_input: "Novorossiysk", mode_input: "vote" })
      });
      await fetch(`${SUPABASE_URL}/rest/v1/rpc/reset_votes`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({ city_name: "Novorossiysk", mode_name: "vote" })
      });
      updateVotesDisplay();
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: currentLat, lng: currentLng },
        zoom: 14
      });
      streetView = new google.maps.StreetViewPanorama(document.getElementById("streetView"), {
        position: { lat: currentLat, lng: currentLng },
        pov: { heading: 0, pitch: 0 },
        visible: true
      });
      map.setStreetView(streetView);
      updateVotesDisplay();
      setInterval(updateVotesDisplay, 4000); // –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 4 —Å–µ–∫—É–Ω–¥—ã
    }

    window.onload = initMap;
  </script>
</body>
</html>
