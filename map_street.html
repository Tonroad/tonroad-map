<!DOCTYPE html>
<html>
  <head>
    <title>TonRoad Street View</title>
    <meta charset="utf-8" />
    <style>
      html, body { height: 100%; margin: 0; padding: 0; }
      #map, #pano { height: 100%; width: 100%; position: absolute; }
      .controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
      }
      .controls button {
        display: block;
        margin-bottom: 5px;
        width: 100px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  </head>
  <body>
    <div class="controls">
      <button onclick="castVote('left')">‚Üê Left</button>
      <button onclick="castVote('straight')">‚Üë Straight</button>
      <button onclick="castVote('right')">‚Üí Right</button>
      <button onclick="drive()">üöó –ï–•–ê–¢–¨</button>
    </div>
    <div id="pano"></div>

    <script>
      const SUPABASE_URL = 'https://qsdaooxvznloo9yheyu.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do';
      const HEADERS = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
      };

      let pano;
      let currentLatLng = { lat: 44.7238, lng: 37.7686 }; // Novorossiysk –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      let currentHeading = 0;

      async function initPosition() {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/current_position?select=lat,lng,heading&order=updated_at.desc&limit=1`, { headers: HEADERS });
        const data = await res.json();
        if (data.length > 0) {
          currentLatLng.lat = data[0].lat;
          currentLatLng.lng = data[0].lng;
          currentHeading = data[0].heading || 0;
        }
      }

      async function castVote(direction) {
        await fetch(`${SUPABASE_URL}/functions/v1/cast_vote-ts`, {
          method: 'POST',
          headers: HEADERS,
          body: JSON.stringify({ city: 'Novorossiysk', mode: 'default', direction })
        });
        alert('‚úî –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω: ' + direction);
      }

      async function drive() {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/votes_summary?city=eq.Novorossiysk&mode=eq.default`, { headers: HEADERS });
        const votes = await res.json();
        let max = 0, selected = 'straight';

        for (let row of votes) {
          if (row.count > max) {
            max = row.count;
            selected = row.direction;
          }
        }

        if (selected === 'left') currentHeading -= 90;
        if (selected === 'right') currentHeading += 90;

        currentHeading = (currentHeading + 360) % 360;
        const headingRadians = currentHeading * Math.PI / 180;
        const distance = 0.0003;

        currentLatLng.lat += Math.cos(headingRadians) * distance;
        currentLatLng.lng += Math.sin(headingRadians) * distance;

        pano.setPosition(currentLatLng);
        pano.setPov({ heading: currentHeading, pitch: 0 });

        await savePosition();
        await resetVotes();
      }

      async function savePosition() {
        await fetch(`${SUPABASE_URL}/rest/v1/current_position`, {
          method: 'POST',
          headers: HEADERS,
          body: JSON.stringify({
            city: 'Novorossiysk',
            lat: currentLatLng.lat,
            lng: currentLatLng.lng,
            heading: currentHeading
          })
        });
      }

      async function resetVotes() {
        await fetch(`${SUPABASE_URL}/functions/v1/bright-endpoint`, {
          method: 'POST',
          headers: HEADERS,
          body: JSON.stringify({ city_name: 'Novorossiysk', mode_name: 'default' })
        });
      }

      async function initMap() {
        await initPosition();
        pano = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
          position: currentLatLng,
          pov: { heading: currentHeading, pitch: 0 },
          visible: true
        });
      }

      window.onload = initMap;
    </script>
  </body>
</html>
