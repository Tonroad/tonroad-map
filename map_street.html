<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Voting & Driving</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height: 33%; width: 100%; }
    #street-view { height: 67%; width: 100%; }
    
    #modeLabel {
      position: absolute; top: 10px; left: 10px;
      background: green; color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
      user-select: none;
    }
    #citySelect {
      position: absolute; top: 10px; right: 10px;
      z-index: 1000; padding: 5px;
      user-select: none;
    }
    #voteResults {
      position: absolute; top: 50px; left: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000;
      user-select: none;
    }
    #radioToggle {
      position: absolute; top: 90px; right: 10px;
      z-index: 1000;
      background: orange; color: white;
      padding: 5px 10px; border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
    #driveControls {
      position: absolute; bottom: 10px; left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      user-select: none;
    }
    #driveControls button {
      margin: 0 5px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: #4285F4;
      color: white;
      cursor: pointer;
      user-select: none;
    }
    #driveControls button:disabled {
      background-color: gray;
      cursor: not-allowed;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <div id="modeLabel" title="Клик для переключения режима">Режим: Свободная езда</div>
  
  <select id="citySelect" title="Выбрать город">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>

  <div id="voteResults">Голосов: 0</div>

  <div id="radioToggle" title="Включить/выключить радио">▶ Радио</div>

  <div id="driveControls" style="display:none;">
    <button id="btnLeft" title="Повернуть влево">⬅ Влево</button>
    <button id="btnStraight" title="Ехать прямо">⬆ Прямо</button>
    <button id="btnRight" title="Повернуть вправо">➡ Вправо</button>
    <button id="btnGo" title="Поехать выбранным направлением" disabled>Ехать ▶</button>
  </div>

  <div id="map"></div>
  <div id="street-view"></div>

<script>
  let map, streetView;
  let mode = "free"; // free, voting, driving
  let votes = { left:0, right:0, straight:0 };
  let selectedDirection = null;

  const cities = {
    Berlin: { lat: 52.52, lng: 13.405 },
    Leipzig: { lat: 51.3397, lng: 12.3731 },
    Dresden: { lat: 51.0504, lng: 13.7373 },
    Novorossiysk: { lat: 44.7236, lng: 37.7689 }
  };

  let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
  radio.loop = true;
  radio.volume = 0.5;
  let radioPlaying = false;

  function initMap() {
    const defaultCity = cities.Berlin;
    map = new google.maps.Map(document.getElementById("map"), {
      center: defaultCity,
      zoom: 14
    });

    streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
      position: defaultCity,
      pov: { heading: 0, pitch: 0 },
      visible: true
    });

    map.setStreetView(streetView);
  }

  function resetVotes() {
    votes = { left:0, right:0, straight:0 };
    selectedDirection = null;
    updateVoteResults();
    updateDriveControls();
  }

  function updateVoteResults() {
    const total = votes.left + votes.straight + votes.right;
    document.getElementById("voteResults").textContent = 
      `Голосов: ${total} (Влево: ${votes.left}, Прямо: ${votes.straight}, Вправо: ${votes.right})`;
  }

  function updateDriveControls() {
    document.getElementById("btnGo").disabled = !selectedDirection;
    // Подсвечиваем выбранное направление
    ["btnLeft", "btnStraight", "btnRight"].forEach(id => {
      document.getElementById(id).style.backgroundColor = "#4285F4";
    });
    if(selectedDirection) {
      const btnId = "btn" + selectedDirection.charAt(0).toUpperCase() + selectedDirection.slice(1);
      document.getElementById(btnId).style.backgroundColor = "#0f9d58"; // зеленый
    }
  }

  document.getElementById("modeLabel").addEventListener("click", () => {
    if (mode === "free") {
      mode = "voting";
      document.getElementById("modeLabel").textContent = "Режим: Голосование";
      document.getElementById("modeLabel").style.background = "red";
      document.getElementById("driveControls").style.display = "flex";
      resetVotes();
    } else if (mode === "voting") {
      mode = "driving";
      document.getElementById("modeLabel").textContent = "Режим: Вождение";
      document.getElementById("modeLabel").style.background = "orange";
      document.getElementById("driveControls").style.display = "flex";
      selectedDirection = null;
      updateDriveControls();
    } else {
      mode = "free";
      document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
      document.getElementById("modeLabel").style.background = "green";
      document.getElementById("driveControls").style.display = "none";
      resetVotes();
    }
  });

  document.getElementById("citySelect").addEventListener("change", e => {
    const city = cities[e.target.value];
    if(city){
      map.setCenter(city);
      streetView.setPosition(city);
      streetView.setPov({ heading: 0, pitch: 0 });
      resetVotes();
    }
  });

  ["btnLeft", "btnStraight", "btnRight"].forEach(id => {
    document.getElementById(id).addEventListener("click", () => {
      if(mode === "free") return; // в свободном режиме кнопки не работают
      const dir = id.replace("btn", "").toLowerCase();
      votes[dir]++;
      selectedDirection = dir;
      updateVoteResults();
      updateDriveControls();
    });
  });

  document.getElementById("btnGo").addEventListener("click", () => {
    if(!selectedDirection) return;

    // Вращаем камеру панорамы
    let pov = streetView.getPov();
    if(selectedDirection === "left") pov.heading -= 45;
    else if(selectedDirection === "right") pov.heading += 45;
    // straight - без поворота
    streetView.setPov(pov);

    // Сообщение о соответствии выбора большинству голосов
    const maxDir = Object.keys(votes).reduce((a,b) => votes[a] > votes[b] ? a : b);
    if(selectedDirection === maxDir){
      alert(`Вы поехали ${selectedDirection}. Это направление выбрало большинство.`);
    } else {
      alert(`Вы поехали ${selectedDirection}, но большинство голосовало за ${maxDir}.`);
    }

    resetVotes();
  });

  document.getElementById("radioToggle").addEventListener("click", () => {
    if(radioPlaying){
      radio.pause();
      radioPlaying = false;
      document.getElementById("radioToggle").textContent = "▶ Радио";
    } else {
      radio.play();
      radioPlaying = true;
      document.getElementById("radioToggle").textContent = "⏸ Радио";
    }
  });

  window.onload = () => {
    try {
      const tg = window.Telegram.WebApp;
      tg.ready();
      window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
    } catch(e){
      console.error("Ошибка Telegram SDK", e);
    }
    initMap();
  };
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>

</body>
</html>
