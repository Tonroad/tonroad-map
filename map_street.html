<!DOCTYPE html>
<html>
<head>
  <title>TonRoad</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #modeLabel {
      position: absolute; top: 10px; left: 10px;
      background: green; color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
    }
    #citySelect {
      position: absolute; top: 10px; right: 10px;
      z-index: 1000; padding: 5px;
    }
    #radioToggle {
      position: absolute; top: 50px; right: 10px;
      background: orange; color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; cursor: pointer;
    }
    #voteInfo {
      position: absolute; top: 80px; left: 10px;
      background: rgba(255,0,0,0.8); color: white;
      padding: 5px 10px; border-radius: 4px;
      z-index: 1000; display: none;
    }
    #voteButtons {
      position: absolute; bottom: 10px; left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 1000;
    }
    .dirBtn {
      margin: 5px;
      padding: 8px 14px;
      background: #4285F4;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="radioToggle">▶ Радио</div>
  <div id="voteInfo">Голосование активно: ⬅ 0 | ⬆ 0 | ➡ 0</div>
  <div id="voteButtons">
    <button class="dirBtn" data-dir="left">⬅ Влево</button>
    <button class="dirBtn" data-dir="straight">⬆ Прямо</button>
    <button class="dirBtn" data-dir="right">➡ Вправо</button>
  </div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

let voteState = {
  mode: "free",
  votes: { left:0, straight:0, right:0 },
  timer: null
};

const cities = {
  Berlin: { lat:52.5200, lng:13.4050 },
  Leipzig: { lat:51.3397, lng:12.3731 },
  Dresden: { lat:51.0504, lng:13.7373 },
  Novorossiysk: { lat:44.7236, lng:37.7689 }
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: cities.Berlin,
    zoom: 14
  });
  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });
  map.setStreetView(streetView);
}

function switchMode() {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    document.getElementById("voteInfo").style.display = "block";
    document.getElementById("voteButtons").style.display = "block";
    streetView.setOptions({
      disableDefaultUI: true,
      clickToGo: false,
      linksControl: false
    });
    resetVotes();
    startVoteTimer();
  } else {
    voteState.mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    document.getElementById("voteInfo").style.display = "none";
    document.getElementById("voteButtons").style.display = "none";
    streetView.setOptions({
      disableDefaultUI: false,
      clickToGo: true,
      linksControl: true
    });
    clearInterval(voteState.timer);
  }
}

function resetVotes() {
  voteState.votes = { left:0, straight:0, right:0 };
  updateVoteInfo();
}

function updateVoteInfo() {
  document.getElementById("voteInfo").textContent =
    `Голосование активно: ⬅ ${voteState.votes.left} | ⬆ ${voteState.votes.straight} | ➡ ${voteState.votes.right}`;
}

function startVoteTimer() {
  voteState.timer = setInterval(() => {
    let { left, straight, right } = voteState.votes;
    let maxDir = "straight";
    let maxVotes = straight;
    if (left > maxVotes) { maxDir = "left"; maxVotes = left; }
    if (right > maxVotes) { maxDir = "right"; maxVotes = right; }
    moveStreetView(maxDir);
    resetVotes();
  }, 5000);
}

function moveStreetView(direction) {
  let pov = streetView.getPov();
  if (direction === "left") {
    pov.heading -= 30;
  } else if (direction === "right") {
    pov.heading += 30;
  }
  streetView.setPov(pov);
}

document.getElementById("modeLabel").addEventListener("click", switchMode);

document.getElementById("citySelect").addEventListener("change", e => {
  const city = e.target.value;
  if (cities[city]) {
    map.setCenter(cities[city]);
    streetView.setPosition(cities[city]);
    streetView.setPov({ heading:0, pitch:0 });
  }
});

document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

document.querySelectorAll(".dirBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (voteState.mode !== "voting") return;
    let dir = btn.dataset.dir;
    voteState.votes[dir]++;
    updateVoteInfo();
  });
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    console.log("Telegram SDK инициализирован");
  } catch(e) {
    console.error("Ошибка Telegram SDK", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
