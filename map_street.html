<!-- ПОЕХАЛИ: полный код map_street.html вставляется здесь (отсюда...) -->
<!-- ⚠️ Из-за лимитов чата я разделю код на 2 части: эта — ЧАСТЬ 1 из 2 -->

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    #map { height:30vh; width:100%; }
    #street-view { height:70vh; width:100%; position:relative; }
    .street-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1001; background:rgba(255,255,255,0); display:none; }
    .mode-label, #citySelect, #voteResults, #coordsDisplay, #driveButton, #backButton { position:absolute; z-index:1002; }
    .mode-label { top:10px; left:10px; background:red; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; }
    #citySelect { top:10px; right:10px; padding:5px; }
    #voteResults { top:50px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #coordsDisplay { top:80px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #driveButton { bottom:100px; right:10px; background:green; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    #backButton { bottom:20px; right:10px; background:orange; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    .vote-buttons { position:absolute; bottom:20px; left:10px; z-index:1002; }
    .vote-buttons button { margin-right:5px; padding:8px 12px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>
  <script>
    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };
    
let hasVoted = false;

    async function initApp() {
      const cities = {
        Berlin: { lat: 52.52, lng: 13.405 },
        Leipzig: { lat: 51.3397, lng: 12.3731 },
        Dresden: { lat: 51.0504, lng: 13.7373 },
        Novorossiysk: { lat: 44.7236, lng: 37.7689 }
      };

      const citySelect = document.getElementById('citySelect');
      const voteResults = document.getElementById('voteResults');
      const coordsDisplay = document.getElementById('coordsDisplay');
      const driveButton = document.getElementById('driveButton');

      const savedCity = localStorage.getItem("selectedCity") || "Berlin";
      citySelect.value = savedCity;

      const map = new google.maps.Map(document.getElementById("map"), {
        center: cities[savedCity],
        zoom: 14
      });

      const panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"),
        {
          position: cities[savedCity],
          pov: { heading: 0, pitch: 0 },
          visible: true
        }
      );
      map.setStreetView(panorama);

      async function fetchCurrentPosition() {
        const res = await fetch("https://qsdaooxywznloogyheyu.supabase.co/rest/v1/current_position?city=eq." + savedCity + "&order=updated_at.desc&limit=1", {
          headers: {
            apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do"
          }
        });
        const data = await res.json();
        if (data.length) {
          const pos = data[0];
          panorama.setPosition({ lat: pos.lat, lng: pos.lng });
          coordsDisplay.textContent = `Координаты: ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}, heading ${pos.heading}`;
        }
      }

      async function fetchVotes() {
        const res = await fetch("https://qsdaooxywznloogyheyu.supabase.co/rest/v1/votes_summary?select=direction,count&city=eq." + savedCity + "&mode=eq.voting", {
          headers: {
            apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do"
          }
        });
        const data = await res.json();
        const votes = { left: 0, straight: 0, right: 0 };
        data.forEach(v => votes[v.direction] = v.count);
        voteResults.textContent = `← ${votes.left} | ↑ ${votes.straight} | → ${votes.right}`;
        return votes;
      }

      async function castVote(dir) {
        if (hasVoted) return;
        hasVoted = true;
        await fetch("https://qsdaooxywznloogyheyu.supabase.co/functions/v1/cast_vote-ts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do",
            Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          },
          body: JSON.stringify({
            city: savedCity,
            mode: "voting",
            direction: dir
          })
        });
        await fetchVotes();
      }

      async function savePosition() {
        const pos = panorama.getPosition();
        const heading = panorama.getPov().heading;
        await fetch("https://qsdaooxywznloogyheyu.supabase.co/rest/v1/current_position", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          },
          body: JSON.stringify({
            city: savedCity,
            lat: pos.lat(),
            lng: pos.lng(),
            heading: heading
          })
        });
      }

      async function resetVotes() {
        await fetch("https://qsdaooxywznloogyheyu.supabase.co/functions/v1/reset_votes", {
          method: "POST",
          headers: {
            apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          },
          body: JSON.stringify({ city: savedCity, mode: "voting" })
        });
      }

      citySelect.addEventListener('change', async e => {
        localStorage.setItem("selectedCity", e.target.value);
        location.reload();
      });

      document.querySelectorAll('.vote-buttons button').forEach(btn => {
        btn.addEventListener("click", () => castVote(btn.dataset.dir));
      });

      driveButton.addEventListener("click", async () => {
        const votes = await fetchVotes();
        const maxDir = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
        const links = panorama.getLinks();
        const best = links.reduce((best, link) => {
          const diff = Math.abs(((link.heading - panorama.getPov().heading + 360) % 360) - {left:270, straight:0, right:90}[maxDir]);
          return diff < best.diff ? { link, diff } : best;
        }, { link: null, diff: 999 });
        if (best.link) {
          panorama.setPov({ heading: best.link.heading, pitch: 0 });
          setTimeout(() => {
            panorama.setPano(best.link.pano);
            savePosition();
            resetVotes();
            hasVoted = false;
          }, 700);
        }
      });

      await fetchCurrentPosition();
      await fetchVotes();
      setInterval(fetchVotes, 5000);
    }
  </script>
</head>
<body>
  <div id="modeLabel" class="mode-label">Режим: Голосование</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults">Загрузка голосов...</div>
  <div id="coordsDisplay">Координаты: ---</div>
  <button id="driveButton">ЕХАТЬ</button>
  <button id="backButton">← Назад</button>
  <div id="map"></div>
  <div id="street-view"><div id="streetOverlay" class="street-overlay"></div></div>
  <div class="vote-buttons">
    <button data-dir="left">← Влево</button>
    <button data-dir="straight">↑ Прямо</button>
    <button data-dir="right">→ Вправо</button>
  </div>
</body>
</html>
