<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tonroad Street View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
        background: #222;
        color: #fff;
      }
      #map, #pano {
        width: 100%;
        height: 50%;
      }
      #info-box {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0,0,0,0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 9999;
        font-size: 14px;
      }
      #controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 9999;
      }
      #controls button {
        margin-right: 5px;
        padding: 6px 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="pano"></div>
    <div id="info-box">Координаты: <span id="coords">загрузка...</span></div>
    <div id="controls">
      <button onclick="move('left')">⬅️ Влево</button>
      <button onclick="move('straight')">⬆️ Прямо</button>
      <button onclick="move('right')">➡️ Вправо</button>
      <button onclick="savePosition()">✅ ЕХАТЬ</button>
    </div>

    <script>
      const supabaseUrl = "https://qsdaooxywzlooghveyu.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";

      let map, pano;
      let currentLat = 44.7236;
      let currentLng = 37.7689;
      let currentHeading = 0;

      async function fetchPosition() {
        const response = await fetch(`${supabaseUrl}/rest/v1/current_position?select=lat,lng,heading&city=eq.Novorossiysk&order=updated_at.desc&limit=1`, {
          headers: {
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`
          }
        });
        const data = await response.json();
        if (data.length > 0) {
          currentLat = data[0].lat;
          currentLng = data[0].lng;
          currentHeading = data[0].heading;
        }
      }

      async function updatePosition() {
        await fetch(`${supabaseUrl}/rest/v1/current_position`, {
          method: 'POST',
          headers: {
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`,
            'Content-Type': 'application/json',
            Prefer: 'return=minimal'
          },
          body: JSON.stringify({
            city: 'Novorossiysk',
            lat: currentLat,
            lng: currentLng,
            heading: currentHeading
          })
        });

        // reset_votes
        await fetch(`${supabaseUrl}/rest/v1/rpc/reset_votes`, {
          method: 'POST',
          headers: {
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            city_name: "Novorossiysk",
            mode_name: "voting"
          })
        });
      }

      function updateMapAndView() {
        const position = { lat: currentLat, lng: currentLng };
        map.setCenter(position);
        pano.setPosition(position);
        pano.setPov({ heading: currentHeading, pitch: 0 });
        document.getElementById('coords').innerText = `lat: ${currentLat.toFixed(5)}, lng: ${currentLng.toFixed(5)}`;
      }

      function move(direction) {
        if (direction === 'left') currentHeading -= 45;
        if (direction === 'right') currentHeading += 45;
        if (direction === 'straight') {
          const headingRad = currentHeading * (Math.PI / 180);
          const distance = 0.0005;
          currentLat += distance * Math.cos(headingRad);
          currentLng += distance * Math.sin(headingRad);
        }
        updateMapAndView();
      }

      async function savePosition() {
        await updatePosition();
        alert("Позиция сохранена и голоса сброшены.");
      }

      async function initMap() {
        await fetchPosition();

        const position = { lat: currentLat, lng: currentLng };
        map = new google.maps.Map(document.getElementById("map"), {
          center: position,
          zoom: 16,
          disableDefaultUI: true
        });

        pano = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
          position: position,
          pov: { heading: currentHeading, pitch: 0 },
          zoom: 1
        });

        map.setStreetView(pano);
        updateMapAndView();
      }

      window.onload = initMap;
    </script>
  </body>
</html>
