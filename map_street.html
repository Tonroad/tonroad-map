<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TonRoad</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:30%; }
    #pano { height:70%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: red; color:white;
      padding:5px 10px; z-index:1000;
      border-radius:4px;
    }
    #voteInfo {
      position:absolute;
      top:50px; left:10px;
      background: rgba(0,0,0,0.6);
      color:white;
      padding:5px 10px;
      z-index:1000;
      border-radius:4px;
    }
    #resultMsg {
      position:absolute;
      top:90px; left:10px;
      background: orange;
      color:black;
      padding:5px 10px;
      z-index:1000;
      border-radius:4px;
      display:none;
    }
    #radioToggle {
      position: absolute;
      top: 10px; right: 10px;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      cursor: pointer;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Голосование</div>
  <div id="voteInfo">Голосов: ←0 | ↑0 | →0</div>
  <div id="resultMsg"></div>
  <div id="radioToggle">▶ Радио</div>
  <div id="map"></div>
  <div id="pano"></div>

<script>
let map, pano;
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const votes = { left:0, straight:0, right:0 };
let lastHeading = 0;

// инициализация карты
function initMap() {
  const startPos = { lat:44.7236, lng:37.7689 }; // Novorossiysk
  map = new google.maps.Map(document.getElementById("map"), {
    center: startPos,
    zoom: 14,
  });

  pano = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
    position: startPos,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(pano);

  pano.addListener("pov_changed", () => {
    const newHeading = pano.getPov().heading;
    checkVoteDirection(newHeading);
    lastHeading = newHeading;
  });
}

// голосование
document.addEventListener("keydown", (e) => {
  if (e.key === "ArrowLeft") {
    votes.left++;
  }
  if (e.key === "ArrowRight") {
    votes.right++;
  }
  if (e.key === "ArrowUp") {
    votes.straight++;
  }
  updateVotes();
});

function updateVotes() {
  document.getElementById("voteInfo").textContent =
    `Голосов: ←${votes.left} | ↑${votes.straight} | →${votes.right}`;
}

// проверка после движения
function checkVoteDirection(currentHeading) {
  let votedDir = getMaxVote();
  let movedDir = getMovedDir(lastHeading, currentHeading);
  if (votedDir && movedDir) {
    if (votedDir === movedDir) {
      showResult("Вы поехали туда куда голосовали");
    } else {
      showResult("Вы не туда повернули!");
    }
  }
  resetVotes();
}

function getMaxVote() {
  let max = 0;
  let dir = null;
  for (let [key,val] of Object.entries(votes)) {
    if (val > max) {
      max = val;
      dir = key;
    }
  }
  return dir;
}

function getMovedDir(oldH, newH) {
  const diff = newH - oldH;
  if (Math.abs(diff) < 15) return "straight";
  if (diff > 15) return "right";
  if (diff < -15) return "left";
  return null;
}

function showResult(msg) {
  const el = document.getElementById("resultMsg");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => { el.style.display = "none"; }, 3000);
}

function resetVotes() {
  votes.left = 0;
  votes.straight = 0;
  votes.right = 0;
  updateVotes();
}

// радио
document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    console.log("Telegram SDK готов");
  } catch(e) {
    console.error("Telegram SDK ошибка", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=ТВОЙ_КЛЮЧ&callback=initMap" async defer></script>
</body>
</html>
