<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    #map { height:30vh; width:100%; }
    #street-view { height:70vh; width:100%; position:relative; }
    .street-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1001; background:rgba(255,255,255,0); display:none; }
    .mode-label, #citySelect, #voteResults, #coordsDisplay, #driveButton, #backButton { position:absolute; z-index:1002; }
    .mode-label { top:10px; left:10px; background:red; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; }
    #citySelect { top:10px; right:10px; padding:5px; }
    #voteResults { top:50px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #coordsDisplay { top:90px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #driveButton { bottom:100px; right:10px; background:green; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    #backButton { bottom:20px; right:10px; background:orange; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    .vote-buttons { position:absolute; bottom:20px; left:10px; z-index:1002; }
    .vote-buttons button { margin-right:5px; padding:8px 12px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>

  <script>
    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };

    function initApp() {
      const SUPA_URL = "https://qsdaooxywznloogyheyu.supabase.co";
      const SUPA_HEADERS = {
        "apikey":        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.…l8Do",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.…l8Do",
        "Content-Type":  "application/json"
      };

      class MapManager {
        constructor(mapEl, streetEl, cities) {
          this.cities = cities;
          this.panorama = new google.maps.StreetViewPanorama(streetEl, {
            position: cities.Berlin,
            pov: { heading:0, pitch:0 },
            visible: true
          });
          this.map = new google.maps.Map(mapEl, {
            center: cities.Berlin,
            zoom: 14
          });
          this.map.setStreetView(this.panorama);
        }
        setCity(cityKey) {
          const p = this.cities[cityKey];
          this.map.setCenter(p);
          this.panorama.setPosition(p);
        }
        setCityPosition(lat, lng) {
          const p = {lat, lng};
          this.map.setCenter(p);
          this.panorama.setPosition(p);
        }
        setInteraction(en) {
          this.panorama.setOptions({ clickToGo: en, linksControl: en });
        }
        findBestLink(dir) {
          const pov = this.panorama.getPov().heading;
          const links = this.panorama.getLinks()||[];
          const want = {straight:0,left:270,right:90}[dir];
          let best = {diff:Infinity,link:null};
          links.forEach(l => {
            let rel = (l.heading-pov+360)%360;
            let d = Math.min(Math.abs(rel-want),360-Math.abs(rel-want));
            if (d<best.diff) best={diff:d,link:l};
          });
          if (!best.link) throw new Error("Нет поворота");
          return best.link;
        }
        rotateAndMove(dir) {
          const l = this.findBestLink(dir);
          this.panorama.setPov({heading:l.heading,pitch:0});
          setTimeout(()=> this.panorama.setPano(l.pano),500);
        }
      }

      class VoteManager {
        constructor(city, mode, disp) {
          this.city = city; this.mode = mode; this.displayEl = disp;
          this.votes = {left:0,straight:0,right:0};
        }
        async load() {
          try {
            const u = `${SUPA_URL}/rest/v1/votes_summary?select=direction,count&city=eq.${this.city}&mode=eq.${this.mode}`;
            const r = await fetch(u, {headers:SUPA_HEADERS});
            const a = await r.json();
            this.votes = {left:0,straight:0,right:0};
            a.forEach(v=>this.votes[v.direction]=v.count);
            this.updateDisplay();
          } catch(e){console.error(e);}
        }
        async vote(dir) {
          this.votes[dir]++; this.updateDisplay();
          try {
            await fetch(`${SUPA_URL}/functions/v1/cast_vote-ts`,{
              method:"POST",
              headers:SUPA_HEADERS,
              body:JSON.stringify({city:this.city,mode:this.mode,direction:dir})
            });
          } catch(e){console.error(e);}
        }
        updateDisplay(){
          this.displayEl.textContent =
            `Влево: ${this.votes.left} | Прямо: ${this.votes.straight} | Вправо: ${this.votes.right}`;
        }
        reset(){
          this.votes={left:0,straight:0,right:0};
          this.updateDisplay();
        }
      }

      class AppController {
        // [2] обновление UI-координат
        updateCoordsDisplay(lat,lng){
          document.getElementById('coordsDisplay').textContent =
            `Координаты: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        constructor(){
          this.cities = {
            Berlin:       {lat:52.52,lng:13.405},
            Leipzig:      {lat:51.3397,lng:12.3731},
            Dresden:      {lat:51.0504,lng:13.7373},
            Novorossiysk: {lat:44.7236,lng:37.7689}
          };
          this.mode = 'voting';
          this.mapMgr = new MapManager(
            document.getElementById('map'),
            document.getElementById('street-view'),
            this.cities
          );
          const sc = localStorage.getItem("selectedCity")||"Berlin";
          this.voteMgr = new VoteManager(sc,'voting',document.getElementById('voteResults'));
          this.mapMgr.setCity(sc);

          this.setupUI();

          this.voteMgr.load();
          this.loadPosition();      // [3] сразу получили coords
          this.updateOverlay();

          setInterval(()=>{
            this.voteMgr.load();
            this.loadPosition();    // [4] синхронизируем coords
          },5000);
        }

        setupUI(){
          document.getElementById('modeLabel')
            .addEventListener('click',()=>this.toggleMode());
          document.getElementById('citySelect')
            .addEventListener('change',e=>{
              this.mapMgr.setCity(e.target.value);
              this.voteMgr.city = e.target.value;
              localStorage.setItem("selectedCity",e.target.value);
              this.voteMgr.reset();
            });
          document.querySelectorAll('.vote-buttons button')
            .forEach(b=>b.addEventListener('click',()=>this.voteMgr.vote(b.dataset.dir)));
          document.getElementById('driveButton')
            .addEventListener('click',()=>this.drive());
          document.getElementById('backButton')
            .addEventListener('click',()=>window.location.href='map.html');
        }

        toggleMode(){
          this.mode = this.mode==='voting'?'free':'voting';
          const lbl = document.getElementById('modeLabel');
          lbl.textContent = `Режим: ${this.mode==='voting'?'Голосование':'Свободная езда'}`;
          lbl.style.background = this.mode==='voting'?'red':'green';
          this.voteMgr.mode = this.mode;
          this.voteMgr.reset();
          this.updateOverlay();
        }

        updateOverlay(){
          const en = this.mode!=='voting';
          document.getElementById('streetOverlay').style.display = en?'none':'block';
          this.mapMgr.setInteraction(en);
        }

        async loadPosition(){
          try {
            const r = await fetch(
              `${SUPA_URL}/rest/v1/current_position?select=lat,lng`,
              {headers:SUPA_HEADERS}
            );
            const a = await r.json();
            if(a.length){
              const {lat,lng} = a[0];
              this.mapMgr.setCityPosition(lat,lng);
              this.updateCoordsDisplay(lat,lng);  // [5]
            }
          }catch(e){console.error(e);}
        }

        async drive(){
          if(this.mode!=='voting') return;
          const tot = Object.values(this.voteMgr.votes).reduce((a,b)=>a+b,0);
          if(!tot){
            this.voteMgr.displayEl.textContent = 'Нет голосов для движения';
            return;
          }
          const md = Object.keys(this.voteMgr.votes)
            .reduce((a,b)=>this.voteMgr.votes[a]>this.voteMgr.votes[b]?a:b);
          try {
            this.mapMgr.rotateAndMove(md);
            this.voteMgr.displayEl.textContent = `Вы поехали как большинство (${md})`;

            const p = this.mapMgr.panorama.getPosition();
            const lat = p.lat(), lng = p.lng();

            this.updateCoordsDisplay(lat,lng);    // [6]
            // 1) обновляем общие coords
            await fetch(
              `${SUPA_URL}/rest/v1/current_position?id=eq.1`, {
                method:"PATCH",
                headers:SUPA_HEADERS,
                body:JSON.stringify([{lat,lng}])
              }
            );
            // 2) удаляем все предыдущие голоса этого city/mode
            await fetch(
              `${SUPA_URL}/rest/v1/votes?city=eq.${this.voteMgr.city}&mode=eq.${this.mode}`, {
                method:"DELETE",
                headers:SUPA_HEADERS
              }
            );
          } catch(e){
            console.warn(e);
            this.voteMgr.displayEl.textContent = 'Нет подходящего поворота';
          }
          this.voteMgr.reset();
        }
      }

      window.app = new AppController();
    }
  </script>
</head>
<body>
  <div id="modeLabel" class="mode-label">Режим: Голосование</div>
  <select id="citySelect">
    <option value="Berlin">Берлин</option>
    <option value="Leipzig">Лейпциг</option>
    <option value="Dresden">Дрезден</option>
    <option value="Novorossiysk">Новороссийск</option>
  </select>
  <div id="voteResults">Влево: 0 | Прямо: 0 | Вправо: 0</div>
  <div id="coordsDisplay">Координаты: — , —</div>
  <button id="driveButton">ЕХАТЬ</button>
  <button id="backButton">← Вернуться на карту</button>
  <div id="map"></div>
  <div id="street-view">
    <div id="streetOverlay" class="street-overlay"></div>
  </div>
  <div class="vote-buttons">
    <button data-dir="left">← Влево</button>
    <button data-dir="straight">↑ Прямо</button>
    <button data-dir="right">→ Вправо</button>
  </div>
</body>
</html>
