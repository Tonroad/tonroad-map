<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#f0f0f0; }
    #map, #pano { width: 100%; }
    #map { height: 30%; }
    #pano { height: 70%; }
    #ui { position: absolute; top: 10px; left: 10px; z-index: 999; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; }
    .btn { padding: 10px; margin: 5px; font-size: 16px; cursor: pointer; }
    #votes { margin-top: 10px; font-weight: bold; }
    #coords { font-size: 12px; color: #333; margin-top: 5px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="pano"></div>
  <div id="ui">
    <div>
      <button class="btn" onclick="vote('left')">← Влево</button>
      <button class="btn" onclick="vote('straight')">↑ Прямо</button>
      <button class="btn" onclick="vote('right')">→ Вправо</button>
    </div>
    <button class="btn" onclick="moveCar()" style="background:green; color:white;">ЕХАТЬ</button>
    <div id="votes">Голоса: -</div>
    <div id="coords">Координаты: -</div>
  </div>

<script>
  const supabase = supabase.createClient(
    'https://qsdaooxywznloogyheyu.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do'
  );

  const city = 'Novorossiysk';
  const mode = 'voting';
  let canVote = true;
  let position = { lat: 44.7236, lng: 37.7689, heading: 0 };
  let map, pano;

  async function loadPosition() {
    const { data } = await supabase.from('current_position').select('*').eq('city', city).single();
    if (data) position = { lat: data.lat, lng: data.lng, heading: data.heading };
  }

  async function savePosition() {
    await supabase.from('current_position').upsert({ city, ...position });
  }

  async function resetVotes() {
    await supabase.rpc('reset_votes', { in_city: city, in_mode: mode });
  }

  async function vote(direction) {
    if (!canVote) return;
    canVote = false;
    const { data: existing } = await supabase
      .from('votes_summary')
      .select('*')
      .eq('city', city)
      .eq('mode', mode)
      .eq('direction', direction)
      .single();

    const count = existing ? existing.count + 1 : 1;

    await supabase.from('votes_summary').upsert({ city, mode, direction, count });
    await loadVotes();
  }

  async function loadVotes() {
    const { data } = await supabase
      .from('votes_summary')
      .select('*')
      .eq('city', city)
      .eq('mode', mode);

    const summary = { left: 0, straight: 0, right: 0 };
    for (const row of data) summary[row.direction] = row.count;

    document.getElementById('votes').innerText =
      `Голоса: ← ${summary.left} | ↑ ${summary.straight} | → ${summary.right}`;
  }

  async function moveCar() {
    const { data } = await supabase
      .from('votes_summary')
      .select('*')
      .eq('city', city)
      .eq('mode', mode);

    const summary = { left: 0, straight: 0, right: 0 };
    for (const row of data) summary[row.direction] = row.count;

    let dir = 'straight';
    if (summary.left > summary.right && summary.left > summary.straight) dir = 'left';
    else if (summary.right > summary.left && summary.right > summary.straight) dir = 'right';

    rotate(dir);
    pano.setPov({ heading: position.heading, pitch: 0 });
    await savePosition();
    await resetVotes();
    await loadVotes();
    canVote = true;
  }

  function rotate(direction) {
    if (direction === 'left') position.heading = (position.heading + 270) % 360;
    if (direction === 'right') position.heading = (position.heading + 90) % 360;
  }

  function updateCoords() {
    document.getElementById('coords').innerText =
      `Координаты: ${position.lat.toFixed(5)}, ${position.lng.toFixed(5)} | Направление: ${position.heading}°`;
  }

  async function sync() {
    await loadVotes();
    await loadPosition();
    pano.setPosition(position);
    pano.setPov({ heading: position.heading, pitch: 0 });
    updateCoords();
  }

  async function init() {
    await loadPosition();
    map = new google.maps.Map(document.getElementById('map'), {
      center: position,
      zoom: 16,
      disableDefaultUI: true
    });

    pano = new google.maps.StreetViewPanorama(
      document.getElementById('pano'),
      {
        position: position,
        pov: { heading: position.heading, pitch: 0 },
        visible: true
      }
    );

    map.setStreetView(pano);
    await resetVotes();
    await loadVotes();
    updateCoords();

    setInterval(sync, 5000);
  }

  window.onload = init;
</script>
</body>
</html>
