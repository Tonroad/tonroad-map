<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#263544; color:#fff; }
    #headerBar { display:flex; align-items:center; gap:10px; padding:12px 8px 2px 8px; }
    #cityLabel { font-size:22px; font-weight:bold; }
    #citySelect { font-size:20px; padding:4px 12px; background:#26a96e; color:#fff; border:none; border-radius:8px; margin-right:10px; }
    #modeLabel { background:#e74c3c; color:#fff; padding:9px 16px; border-radius:10px; font-size:22px; font-weight:bold; }
    #voteResults { background:#222b38; color:#fff; padding:6px 15px; border-radius:10px; font-size:20px; font-weight:bold; margin-left:10px; }
    #topPanel { display:flex; flex-direction:column; gap:10px; }
    #mapPopup { position:fixed; top:0; left:0; width:100vw; height:38vh; background:#fff; z-index:2002; display:none; flex-direction:column; border-radius:0 0 30px 30px; box-shadow:0 8px 32px rgba(0,0,0,.33); }
    #hideMapBtn { background:#19e074; color:#111; font-size:30px; font-weight:bold; padding:14px 0; border-radius:25px; border:none; margin:12px 20vw 0 20vw; cursor:pointer; }
    #mapCanvas { width:100vw; height:25vh; border-radius:0 0 20px 20px; }
    #street-view { width:100vw; height:44vh; }
    #controls { width:100vw; display:flex; flex-direction:column; gap:13px; align-items:center; margin-top:8px; }
    #voteBtns, #mainBtns { display:flex; flex-direction:row; justify-content:center; gap:12px; margin-bottom:0; }
    .btn-vote { font-size:23px; font-weight:bold; border:none; border-radius:12px; padding:19px 23px; margin-bottom:0; cursor:pointer; }
    .btn-vote.left { background:#4d73e8; color:#fff; }
    .btn-vote.straight { background:#2ecc71; color:#fff; }
    .btn-vote.right { background:#ffc43c; color:#222; }
    .btn-main { font-size:22px; font-weight:bold; border:none; border-radius:12px; padding:16px 23px; margin-top:0; cursor:pointer; }
    .btn-main.start { background:#3498db; color:#fff; }
    .btn-main.drive { background:#26a96e; color:#fff; }
    .btn-main.back { background:#ff9100; color:#fff; }
    .btn-main.radio { background:#4ecbfa; color:#111; display:flex; align-items:center; gap:6px; }
    .btn-main.map { background:#3498db; color:#fff; }
    #timerLabel { font-size:21px; background:#222b38; color:#19e074; border-radius:9px; padding:6px 18px; margin:8px 0 0 0; text-align:center; }
    @media (max-width:600px) {
      #voteBtns, #mainBtns { flex-wrap:wrap; gap:8px; }
      .btn-vote, .btn-main { font-size:18px; padding:14px 8vw; }
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>
</head>
<body>
  <div id="headerBar">
    <span id="cityLabel">–ì–æ—Ä–æ–¥:</span>
    <select id="citySelect">
      <option value="Berlin">–ë–µ—Ä–ª–∏–Ω</option>
      <option value="Leipzig">–õ–µ–π–ø—Ü–∏–≥</option>
      <option value="Dresden">–î—Ä–µ–∑–¥–µ–Ω</option>
      <option value="Novorossiysk">–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫</option>
    </select>
    <span id="modeLabel">–†–µ–∂–∏–º: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</span>
    <span id="voteResults">–í–ª–µ–≤–æ: 0 | –ü—Ä—è–º–æ: 0 | –í–ø—Ä–∞–≤–æ: 0</span>
  </div>

  <div id="topPanel">
    <div id="timerLabel" style="display:none"></div>
  </div>

  <div id="mapPopup">
    <button id="hideMapBtn">–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É ‚ñ≤</button>
    <div id="mapCanvas"></div>
  </div>
  <div id="street-view"></div>

  <div id="controls">
    <div id="voteBtns">
      <button class="btn-vote left" data-dir="left">‚Üê –í–ª–µ–≤–æ</button>
      <button class="btn-vote straight" data-dir="straight">‚Üë –ü—Ä—è–º–æ</button>
      <button class="btn-vote right" data-dir="right">‚Üí –í–ø—Ä–∞–≤–æ</button>
    </div>
    <div id="mainBtns">
      <button class="btn-main start">–°—Ç–∞—Ä—Ç</button>
      <button class="btn-main drive">–ï–•–ê–¢–¨</button>
      <button class="btn-main back">–ù–∞–∑–∞–¥</button>
      <button class="btn-main radio" onclick="window.open('https://t.me/fmusbot','_blank')">üéµ –†–∞–¥–∏–æ</button>
      <button class="btn-main map">–ö–∞—Ä—Ç–∞</button>
    </div>
  </div>

  <script>
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const BASE_URL = "https://qsdaooxywznloogyheyu.supabase.co";
    const CITIES = {
      Berlin: { lat: 52.5200, lng: 13.4050 },
      Leipzig: { lat: 51.3397, lng: 12.3731 },
      Dresden: { lat: 51.0504, lng: 13.7373 },
      Novorossiysk: { lat: 44.7236, lng: 37.7689 }
    };

    let selectedCity = localStorage.getItem("selectedCity") || "Berlin";
    document.getElementById("citySelect").value = selectedCity;

    let panorama, streetMap, mapPopup, mapRoutePath;
    let votes = { left: 0, straight: 0, right: 0 };
    let timerValue = 0, timerActive = false, timerInterval = null;
    let routeHistory = {};

    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };

    async function initApp() {
      // STREET VIEW
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById('street-view'),
        { position: CITIES[selectedCity], pov: { heading: 0, pitch: 0 }, visible: true }
      );

      // –ö–ê–†–¢–ê (–í–°–ü–õ–´–í–ê–Æ–©–ê–Ø)
      mapPopup = new google.maps.Map(document.getElementById('mapCanvas'), {
        center: CITIES[selectedCity], zoom: 14
      });

      // –ú–ê–†–®–†–£–¢ –ù–ê –ö–ê–†–¢–ï
      mapRoutePath = new google.maps.Polyline({
        path: [CITIES[selectedCity]],
        geodesic: true,
        strokeColor: "#f90",
        strokeOpacity: 1.0,
        strokeWeight: 6
      });
      mapRoutePath.setMap(mapPopup);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –≥–æ—Ä–æ–¥–∞)
      routeHistory[selectedCity] = [CITIES[selectedCity]];

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
      syncCity(selectedCity);

      // –í–°–ü–õ–´–í–ê–Æ–©–ê–Ø –ö–ê–†–¢–ê: –ü–û–ö–ê–ó/–°–ö–†–´–¢–¨
      document.querySelector('.btn-main.map').onclick = showMapPopup;
      document.getElementById('hideMapBtn').onclick = hideMapPopup;

      // –°–º–µ–Ω–∞ –≥–æ—Ä–æ–¥–∞
      document.getElementById('citySelect').onchange = function(e) {
        selectedCity = e.target.value;
        localStorage.setItem("selectedCity", selectedCity);
        syncCity(selectedCity);
      };

      // –ö–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
      document.querySelectorAll('.btn-vote').forEach(btn =>
        btn.onclick = () => castVote(btn.dataset.dir)
      );

      // –ö–Ω–æ–ø–∫–∞ –ï–•–ê–¢–¨
      document.querySelector('.btn-main.drive').onclick = () => drive();

      // –ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç
      document.querySelector('.btn-main.start').onclick = async () => {
        await resetToStart(selectedCity);
      };

      // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
      document.querySelector('.btn-main.back').onclick = () => Telegram.WebApp.close();

      // –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
      setInterval(updateVotes, 2000);
      setInterval(drawRouteOnMap, 3000);

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
      updateVotes();
      drawRouteOnMap();
    }

    function syncCity(city) {
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Street View –∏ –∫–∞—Ä—Ç—É
      if (panorama) panorama.setPosition(CITIES[city]);
      if (mapPopup) mapPopup.setCenter(CITIES[city]);
      // –°–±—Ä–æ—Å–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      // –û–±–Ω–æ–≤–∏—Ç—å –≥–æ–ª–æ—Å–∞
      updateVotes();
      // –°–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä
      resetTimer();
    }

    async function updateVotes() {
      const url = `${BASE_URL}/rest/v1/votes_summary?select=direction,count&city=eq.${selectedCity}&mode=eq.voting`;
      const res = await fetch(url, { headers: { apikey: API_KEY } });
      const data = await res.json();
      votes = { left: 0, straight: 0, right: 0 };
      data.forEach(v => votes[v.direction] = v.count);
      document.getElementById("voteResults").textContent =
        `–í–ª–µ–≤–æ: ${votes.left} | –ü—Ä—è–º–æ: ${votes.straight} | –í–ø—Ä–∞–≤–æ: ${votes.right}`;
      // –°—Ç–∞—Ä—Ç —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≥–æ–ª–æ—Å–µ
      const total = votes.left + votes.straight + votes.right;
      if (total > 0 && !timerActive) startTimer();
    }

    async function castVote(dir) {
      await fetch(`${BASE_URL}/functions/v1/cast_vote-ts`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: API_KEY,
          Authorization: `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ city: selectedCity, mode: "voting", direction: dir })
      });
      updateVotes();
    }

    function startTimer() {
      timerValue = 5;
      timerActive = true;
      document.getElementById('timerLabel').style.display = "";
      document.getElementById('timerLabel').textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
      timerInterval = setInterval(() => {
        timerValue--;
        document.getElementById('timerLabel').textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
        if (timerValue <= 0) {
          drive();
        }
      }, 1000);
    }
    function resetTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerActive = false;
      timerValue = 0;
      document.getElementById('timerLabel').style.display = "none";
    }

    async function drive() {
      resetTimer();
      // –í—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –º–∞–∫—Å–∏–º—É–º—É
      let maxDir = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
      if (votes[maxDir] === 0) return;
      // –ù–∞–π—Ç–∏ –ª—É—á—à–∏–π –ø–æ–≤–æ—Ä–æ—Ç –≤ Street View
      let bestLink;
      try {
        bestLink = findBestLink(maxDir);
      } catch {
        alert("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è!");
        return;
      }
      // –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ Street View
      let svService = new google.maps.StreetViewService();
      svService.getPanorama({ pano: bestLink.pano }, (data, status) => {
        if (status === google.maps.StreetViewStatus.OK) {
          const nextLatLng = data.location.latLng;
          panorama.setPosition(nextLatLng);
          panorama.setPov({ heading: bestLink.heading, pitch: 0 });
          // –î–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é –º–∞—Ä—à—Ä—É—Ç–∞
          if (!routeHistory[selectedCity]) routeHistory[selectedCity] = [];
          routeHistory[selectedCity].push({ lat: nextLatLng.lat(), lng: nextLatLng.lng() });
          drawRouteOnMap();
        }
      });
      // –°–±—Ä–æ—Å–∏—Ç—å –≥–æ–ª–æ—Å–∞
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${selectedCity}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }

    function findBestLink(dir) {
      const pov = panorama.getPov().heading;
      const links = panorama.getLinks() || [];
      const want = { straight: 0, left: 270, right: 90 }[dir];
      let best = { diff: Infinity, link: null };
      links.forEach(link => {
        let rel = (link.heading - pov + 360) % 360;
        let diff = Math.abs(rel - want);
        diff = Math.min(diff, 360 - diff);
        if (diff < best.diff) best = { diff, link };
      });
      if (!best.link) throw new Error('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞');
      return best.link;
    }

    async function resetToStart(city) {
      panorama.setPosition(CITIES[city]);
      panorama.setPov({ heading: 0, pitch: 0 });
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${city}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }

    function drawRouteOnMap() {
      if (!routeHistory[selectedCity]) return;
      mapRoutePath.setPath(routeHistory[selectedCity]);
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
    }

    function showMapPopup() {
      document.getElementById("mapPopup").style.display = "flex";
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
      google.maps.event.trigger(mapPopup, 'resize');
    }
    function hideMapPopup() {
      document.getElementById("mapPopup").style.display = "none";
    }
  </script>
</body>
</html>
