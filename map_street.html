<!DOCTYPE html>
<html>
<head>
  <title>TonRoad голосование + радио + магазины</title>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:50%; width:100%; }
    #street-view { height:50%; width:100%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: green;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
      cursor: pointer;
    }
    #voteStatus {
      position: absolute;
      top: 10px; right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
    }
    #radioToggle {
      position: absolute;
      top: 50px; left: 10px;
      z-index: 1000;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #warning {
      position: absolute;
      top: 80px; left: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">Режим: Свободная езда</div>
  <div id="voteStatus">Голосов: 0</div>
  <div id="radioToggle">▶ Радио</div>
  <div id="warning">Вы не туда повернули!</div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteState = { mode: "free", votes: {}, timer: null, direction: null };
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { position: { lat: 52.5200, lng: 13.4050 } },
  Leipzig: { position: { lat: 51.3397, lng: 12.3731 } },
  Dresden: { position: { lat: 51.0504, lng: 13.7373 } },
  Novorossiysk: { position: { lat: 44.7236, lng: 37.7689 } }
};

const shops = [
  { name: "Shop A", position: { lat: 52.5210, lng: 13.4060 }, url: "https://shopA.example.com" },
  { name: "Shop B", position: { lat: 51.3390, lng: 12.3720 }, url: "https://shopB.example.com" }
];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: cities.Berlin.position
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin.position,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(streetView);

  // магазины
  shops.forEach(shop => {
    const marker = new google.maps.Marker({
      position: shop.position,
      map: map,
      title: shop.name
    });
    const info = new google.maps.InfoWindow({
      content: `<strong>${shop.name}</strong><br><a href="${shop.url}" target="_blank">Перейти в магазин</a>`
    });
    marker.addListener("click", () => info.open(map, marker));
  });

  // переход по городам
  document.getElementById("modeLabel").addEventListener("click", switchMode);
}

function switchMode() {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    voteState.votes = {};
    voteState.direction = null;
    document.getElementById("modeLabel").textContent = "Режим: Голосование";
    document.getElementById("modeLabel").style.background = "red";
    startVoting();
  } else {
    voteState.mode = "free";
    document.getElementById("modeLabel").textContent = "Режим: Свободная езда";
    document.getElementById("modeLabel").style.background = "green";
    document.getElementById("voteStatus").textContent = "Голосов: 0";
    clearTimeout(voteState.timer);
  }
}

function startVoting() {
  document.getElementById("voteStatus").textContent = "Голосуем (5 секунд)";
  voteState.votes = { left: 0, right: 0, straight: 0 };
  voteState.timer = setTimeout(() => {
    const max = Math.max(voteState.votes.left, voteState.votes.right, voteState.votes.straight);
    let chosen = "straight";
    for (let [dir, val] of Object.entries(voteState.votes)) {
      if (val === max) chosen = dir;
    }
    voteState.direction = chosen;
    document.getElementById("voteStatus").textContent = `Выбрано направление: ${chosen.toUpperCase()}, нажмите стрелку!`;
    observeDirection(chosen);
  }, 5000);
}

// для стрелок Google
function observeDirection(expected) {
  let check = setInterval(() => {
    const pov = streetView.getPov();
    let dir;
    if (pov.heading >= -45 && pov.heading <= 45) dir = "straight";
    else if (pov.heading > 45 && pov.heading <= 135) dir = "right";
    else if (pov.heading < -45 && pov.heading >= -135) dir = "left";
    else dir = "back";
    if (dir === expected) {
      document.getElementById("warning").style.display = "none";
    } else {
      document.getElementById("warning").style.display = "block";
    }
    if (voteState.mode !== "voting") clearInterval(check);
  }, 1000);
}

// имитация голосования
document.addEventListener("keydown", e => {
  if (voteState.mode !== "voting") return;
  let dir;
  if (e.key === "ArrowLeft") dir = "left";
  if (e.key === "ArrowRight") dir = "right";
  if (e.key === "ArrowUp") dir = "straight";
  if (dir) {
    voteState.votes[dir]++;
    document.getElementById("voteStatus").textContent = `Голосов: Влево(${voteState.votes.left}) | Прямо(${voteState.votes.straight}) | Вправо(${voteState.votes.right})`;
  }
});

// радио
document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "▶ Радио";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "⏸ Радио";
  }
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
    console.log("Telegram SDK ready");
  } catch(e) {
    console.error("Telegram SDK error", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
