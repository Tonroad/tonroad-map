<!DOCTYPE html><html>
<head>
  <title>TonRoad Map Voting</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background-color: #1e1e2f; color: #fff; }
    #map, #pano { height: 40vh; width: 100%; }
    #controls { padding: 1em; text-align: center; }
    .btn { padding: 1em 2em; margin: 0.5em; font-size: 1.2em; cursor: pointer; border-radius: 8px; }
    #status, #votes, #position, #modeToggle { margin-top: 1em; font-weight: bold; }
    #log { font-size: 0.9em; color: #aaa; max-height: 100px; overflow-y: auto; text-align: left; margin: 1em; background: #111; padding: 0.5em; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="pano"></div>
  <div id="controls">
    <div>
      <button class="btn" onclick="castVote('left')">⬅️ Влево</button>
      <button class="btn" onclick="castVote('straight')">⬆️ Прямо</button>
      <button class="btn" onclick="castVote('right')">➡️ Вправо</button>
    </div>
    <div id="votes"></div>
    <div id="position">Загрузка позиции...</div>
    <div>
      <button class="btn" onclick="moveCar()">ЕХАТЬ</button>
    </div>
    <div>
      <button class="btn" id="modeToggle" onclick="toggleMode()">Режим: голосование</button>
    </div>
    <div id="status"></div>
  </div>
  <div id="log"></div>  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8"></script>  <script>
    const supabaseUrl = "https://qsdaooxywznloogygheyu.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    const city = "Novorossiysk";
    let mode = "default";
    let voted = false;

    let map, panorama, currentLat = 44.7238, currentLng = 37.7689, heading = 0;
    let polyline;
    let pathHistory = [];

    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.innerHTML += `&gt; ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function loadPosition() {
      const { data } = await supabase.from('current_position').select('*').eq('city', city).single();
      if (data) {
        currentLat = data.lat;
        currentLng = data.lng;
        heading = data.heading;
        updatePositionUI();
        updateMap();
        log(`Загружена позиция: ${currentLat}, ${currentLng}, heading ${heading}`);
      }
    }

    function updatePositionUI() {
      document.getElementById("position").innerText = `Текущая позиция: ${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}, heading: ${heading}`;
    }

    function updateMap() {
      const position = { lat: currentLat, lng: currentLng };
      if (!map || !panorama) return;
      map.setCenter(position);
      panorama.setPosition(position);
      panorama.setPov({ heading, pitch: 0 });
      pathHistory.push(position);
      polyline.setPath(pathHistory);
    }

    function initMap() {
      const position = { lat: currentLat, lng: currentLng };
      map = new google.maps.Map(document.getElementById("map"), {
        center: position,
        zoom: 16,
        disableDefaultUI: true,
        styles: [{ elementType: 'geometry', stylers: [{ color: '#242f3e' }] }]
      });
      panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
        position,
        pov: { heading, pitch: 0 },
      });
      map.setStreetView(panorama);
      polyline = new google.maps.Polyline({
        path: [],
        geodesic: true,
        strokeColor: "#00FFAA",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map: map
      });
    }

    async function castVote(direction) {
      if (voted || mode !== "default") {
        document.getElementById("status").innerText = "Вы уже проголосовали или режим неактивен.";
        return;
      }
      voted = true;
      const { error } = await supabase.rpc('cast_vote_ts', {
        p_city: city,
        p_mode: mode,
        p_direction: direction,
      });
      if (!error) {
        document.getElementById("status").innerText = `Голос за '${direction}' принят!`;
        loadVotes();
      }
    }

    async function loadVotes() {
      const { data } = await supabase.from('votes_summary').select('*').eq('city', city).eq('mode', mode);
      if (data) {
        const votes = { left: 0, straight: 0, right: 0 };
        data.forEach(row => {
          votes[row.direction] = row.count;
        });
        document.getElementById("votes").innerText = `Голоса: ⬅️ ${votes.left} | ⬆️ ${votes.straight} | ➡️ ${votes.right}`;
      }
    }

    async function moveCar() {
      const { data } = await supabase.from('votes_summary').select('*').eq('city', city).eq('mode', mode);
      if (!data || data.length === 0) return;
      let maxDir = 'straight';
      let maxVal = -1;
      data.forEach(row => {
        if (row.count > maxVal) {
          maxVal = row.count;
          maxDir = row.direction;
        }
      });
      switch (maxDir) {
        case 'left': heading -= 90; break;
        case 'right': heading += 90; break;
      }
      heading = (heading + 360) % 360;
      const rad = heading * Math.PI / 180;
      const step = 0.0005;
      currentLat += Math.cos(rad) * step;
      currentLng += Math.sin(rad) * step;

      await supabase.from('current_position').upsert({ city, lat: currentLat, lng: currentLng, heading });
      await supabase.rpc('reset_votes', { p_city: city, p_mode: mode });
      voted = false;
      updatePositionUI();
      updateMap();
      loadVotes();
      log(`Машина перемещена в ${currentLat}, ${currentLng}`);
    }

    function toggleMode() {
      mode = mode === "default" ? "free" : "default";
      document.getElementById("modeToggle").innerText = `Режим: ${mode === "default" ? "голосование" : "свободный"}`;
      voted = false;
      loadVotes();
      log(`Режим переключен на ${mode}`);
    }

    window.onload = async () => {
      Telegram.WebApp.ready();
      Telegram.WebApp.MainButton.setText("Голосовать");
      Telegram.WebApp.MainButton.show();
      await loadPosition();
      initMap();
      loadVotes();
      setInterval(() => {
        loadVotes();
        loadPosition();
      }, 5000);
    };
  </script></body>
</html>
