<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    #map { height:30vh; width:100%; }
    #street-view { height:70vh; width:100%; position:relative; }
    .street-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1001; background:rgba(255,255,255,0); display:none; }
    .mode-label, #citySelect, #voteResults, #driveButton, #backButton { position:absolute; z-index:1002; }
    .mode-label { top:10px; left:10px; background:red; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; }
    #citySelect { top:10px; right:10px; padding:5px; }
    #voteResults { top:50px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; }
    #driveButton { bottom:100px; right:10px; background:green; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    #backButton { bottom:20px; right:10px; background:orange; color:#fff; padding:10px 15px; border-radius:4px; cursor:pointer; }
    .vote-buttons { position:absolute; bottom:20px; left:10px; z-index:1002; }
    .vote-buttons button { margin-right:5px; padding:8px 12px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>

  <script>
    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };

    function initApp() {
            class MapManager {
        constructor(mapEl, streetEl, cities) {
          this.cities = cities;
          this.panorama = new google.maps.StreetViewPanorama(streetEl, {
            position: cities.Berlin, pov: { heading: 0, pitch: 0 }, visible: true
          });
          this.map = new google.maps.Map(mapEl, { center: cities.Berlin, zoom: 14 });
          this.map.setStreetView(this.panorama);
        }
        setCity(cityKey) {
          const pos = this.cities[cityKey];
          this.map.setCenter(pos);
          this.panorama.setPosition(pos);
        }
        setInteraction(enabled) {
          this.panorama.setOptions({ clickToGo: enabled, linksControl: enabled });
        }
        findBestLink(dir) {
          const pov = this.panorama.getPov().heading;
          const links = this.panorama.getLinks() || [];
          const want = { straight: 0, left: 270, right: 90 }[dir];
          let best = { diff: Infinity, link: null };
          links.forEach(link => {
            let rel = (link.heading - pov + 360) % 360;
            let diff = Math.abs(rel - want);
            diff = Math.min(diff, 360 - diff);
            if (diff < best.diff) best = { diff, link };
          });
          if (!best.link) throw new Error('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞');
          return best.link;
        }
        rotateAndMove(dir) {
          const link = this.findBestLink(dir);
          this.panorama.setPov({ heading: link.heading, pitch: 0 });
          setTimeout(() => this.panorama.setPano(link.pano), 500);
        }
      }

      class VoteManager {
        constructor(city, mode, displayEl) {
          this.city = city;
          this.mode = mode;
          this.displayEl = displayEl;
          this.votes = { left: 0, straight: 0, right: 0 };
        }

        async load() {
          try {
            const url = https://qsdaooxywznloogyheyu.supabase.co/rest/v1/votes_summary?select=direction,count&city=eq.${this.city}&mode=eq.${this.mode};
            const response = await fetch(url, {
              headers: {
                apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              }
            });
            const data = await response.json();
            this.votes = { left: 0, straight: 0, right: 0 };
            data.forEach(v => this.votes[v.direction] = v.count);
            this.updateDisplay();
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤', e);
          }
        }

        async vote(dir) {
          this.votes[dir]++;
          this.updateDisplay();
          try {
            await fetch("https://qsdaooxywznloogyheyu.supabase.co/functions/v1/cast_vote-ts", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              },
              body: JSON.stringify({
                city: this.city,
                mode: this.mode,
                direction: dir
              })
            });
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞', e);
          }
        }

        updateDisplay() {
          this.displayEl.textContent = –í–ª–µ–≤–æ: ${this.votes.left} | –ü—Ä—è–º–æ: ${this.votes.straight} | –í–ø—Ä–∞–≤–æ: ${this.votes.right};
        }

        reset() {
          this.votes = { left: 0, straight: 0, right: 0 };
          this.updateDisplay();
        }
      }

      class AppController {
        constructor() {
          this.cities = {
            Berlin: { lat: 52.52, lng: 13.405 },
            Leipzig: { lat: 51.3397, lng: 12.3731 },
            Dresden: { lat: 51.0504, lng: 13.7373 },
            Novorossiysk: { lat: 44.7236, lng: 37.7689 }
          };
          this.mode = 'voting';
          this.mapMgr = new MapManager(
            document.getElementById('map'),
            document.getElementById('street-view'),
            this.cities
          );
          const savedCity = localStorage.getItem("selectedCity") || "Berlin";
          this.voteMgr = new VoteManager(savedCity, 'voting', document.getElementById('voteResults'));
          this.mapMgr.setCity(savedCity);
          this.overlay = document.getElementById('streetOverlay');
          this.setupUI();
          this.voteMgr.load();
          this.updateOverlay();
        }

        setupUI() {
          document.getElementById('modeLabel').addEventListener('click', () => this.toggleMode());
          document.getElementById('citySelect').addEventListener('change', async e => {
            this.mapMgr.setCity(e.target.value);
            this.voteMgr.city = e.target.value;
            localStorage.setItem("selectedCity", e.target.value);
            await this.voteMgr.load();
          });
          document.querySelectorAll('.vote-buttons button').forEach(btn =>
            btn.addEventListener('click', () => this.voteMgr.vote(btn.dataset.dir))
          );
          document.getElementById('driveButton').addEventListener('click', () => this.drive());
          document.getElementById('backButton').addEventListener('click', () => {
            window.location.href = 'map.html';
          });
        }

        toggleMode() {
          this.mode = this.mode === 'voting' ? 'free' : 'voting';
          document.getElementById('modeLabel').textContent = –†–µ–∂–∏–º: ${this.mode === 'voting' ? '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ' : '–°–≤–æ–±–æ–¥–Ω–∞—è –µ–∑–¥–∞'};
          document.getElementById('modeLabel').style.background = this.mode === 'voting' ? 'red' : 'green';
          this.voteMgr.mode = this.mode;
          this.voteMgr.reset();
          this.updateOverlay();
        }

        updateOverlay() {
          const enabled = this.mode !== 'voting';
          this.overlay.style.display = enabled ? 'none' : 'block';
          this.mapMgr.setInteraction(enabled);
        }

        drive() {
          if (this.mode !== 'voting') return;
          const total = Object.values(this.voteMgr.votes).reduce((a, b) => a + b, 0);
          if (total === 0) {
            this.voteMgr.displayEl.textContent = '–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è';
            return;
          }
          const maxDir = Object.keys(this.voteMgr.votes).reduce((a, b) =>
            this.voteMgr.votes[a] > this.voteMgr.votes[b] ? a : b
          );
          try {
            this.mapMgr.rotateAndMove(maxDir);
            this.voteMgr.displayEl.textContent = –í—ã –ø–æ–µ—Ö–∞–ª–∏ –∫–∞–∫ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ (${maxDir});

            // üõ∞Ô∏è –®–∞–≥ 2: –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ Supabase
            const position = this.mapMgr.panorama.getPosition();
            const heading = this.mapMgr.panorama.getPov().heading;
            updateCurrentPosition(this.voteMgr.city, position.lat(), position.lng(), heading);
          } catch (e) {
            console.warn(e);
            this.voteMgr.displayEl.textContent = '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞';
          }
          this.voteMgr.reset();
        }
      }

      const app = new AppController();

      setInterval(() => {
        app.voteMgr.load();
      }, 5000);

      // üîÑ –®–∞–≥ 2: —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      async function updateCurrentPosition(city, lat, lng, heading) {
        try {
          await fetch("https://qsdaooxywznloogyheyu.supabase.co/rest/v1/current_position", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            },
            body: JSON.stringify({ city, lat, lng, heading })
          });
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏:", e);
        }
      }
    }
  </script>
  </head>
<body>
  <div id="modeLabel" class="mode-label">–†–µ–∂–∏–º: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
  <select id="citySelect">
    <option value="Berlin">–ë–µ—Ä–ª–∏–Ω</option>
    <option value="Leipzig">–õ–µ–π–ø—Ü–∏–≥</option>
    <option value="Dresden">–î—Ä–µ–∑–¥–µ–Ω</option>
    <option value="Novorossiysk">–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫</option>
  </select>
  <div id="voteResults">–í–ª–µ–≤–æ: 0 | –ü—Ä—è–º–æ: 0 | –í–ø—Ä–∞–≤–æ: 0</div>
  <button id="driveButton">–ï–•–ê–¢–¨</button>
  <button id="backButton">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç—É</button>
  <div id="map"></div>
  <div id="street-view"><div id="streetOverlay" class="street-overlay"></div></div>
  <div class="vote-buttons">
    <button data-dir="left">‚Üê –í–ª–µ–≤–æ</button>
    <button data-dir="straight">‚Üë –ü—Ä—è–º–æ</button>
    <button data-dir="right">‚Üí –í–ø—Ä–∞–≤–æ</button>
  </div>
</body>
</html>
