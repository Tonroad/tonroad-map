<!DOCTYPE html>
<html>
<head>
  <title>TonRoad</title>
  <meta charset="utf-8" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 50%; width: 100%; }
    #street-view { height: 50%; width: 100%; }
    #modeLabel {
      position: absolute;
      top: 10px; left: 10px;
      background: green;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      z-index: 1000;
    }
    #citySelect {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1000;
      padding: 5px;
    }
    #radioToggle {
      position: absolute;
      top: 50px; right: 10px;
      z-index: 1000;
      background: orange;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="modeLabel">–†–µ–∂–∏–º: –°–≤–æ–±–æ–¥–Ω–∞—è –µ–∑–¥–∞</div>
  <select id="citySelect">
    <option value="Berlin">–ë–µ—Ä–ª–∏–Ω</option>
    <option value="Leipzig">–õ–µ–π–ø—Ü–∏–≥</option>
    <option value="Dresden">–î—Ä–µ–∑–¥–µ–Ω</option>
    <option value="Novorossiysk">–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫</option>
  </select>
  <div id="radioToggle">‚ñ∂ –†–∞–¥–∏–æ</div>
  <div id="map"></div>
  <div id="street-view"></div>

<script>
let map, streetView;
let voteState = { mode: "free" }; // free | voting
let radio = new Audio("https://icecast.radiohitz.club/club.mp3");
radio.loop = true;
radio.volume = 0.5;
let radioPlaying = false;

const cities = {
  Berlin: { position: { lat: 52.5200, lng: 13.4050 } },
  Leipzig: { position: { lat: 51.3397, lng: 12.3731 } },
  Dresden: { position: { lat: 51.0504, lng: 13.7373 } },
  Novorossiysk: { position: { lat: 44.7236, lng: 37.7689 } }
};

let cityMarkers = {};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: cities.Berlin.position
  });

  streetView = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
    position: cities.Berlin.position,
    pov: { heading: 0, pitch: 0 },
    visible: true
  });

  map.setStreetView(streetView);

  for (let [name, data] of Object.entries(cities)) {
    const marker = new google.maps.Marker({
      position: data.position,
      map: map,
      title: name
    });
    data.marker = marker;
    cityMarkers[name] = data;

    marker.addListener("click", () => {
      if (voteState.mode === "voting") {
        registerVote(name);
      }
      streetView.setPosition(data.position);
      streetView.setPov({ heading: 0, pitch: 0 });
    });
  }
}

// –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
function registerVote(cityName) {
  const userId = window.telegramUserId || "unknown";
  fetch("/api/vote", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ city: cityName, userId })
  })
    .then(r => r.json())
    .then(data => {
      alert(`–ì–æ–ª–æ—Å –∑–∞ ${data.voted} –ø—Ä–∏–Ω—è—Ç!`);
      if (data.winner && cityMarkers[data.winner]) {
        Object.values(cityMarkers).forEach(c => c.marker.setLabel(null));
        cityMarkers[data.winner].marker.setLabel({
          text: "üèÜ",
          color: "red",
          fontWeight: "bold"
        });
      }
    })
    .catch(e => console.error("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è", e));
}

// –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
document.getElementById("modeLabel").addEventListener("click", () => {
  if (voteState.mode === "free") {
    voteState.mode = "voting";
    document.getElementById("modeLabel").textContent = "–†–µ–∂–∏–º: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ";
    document.getElementById("modeLabel").style.background = "green";
  } else {
    voteState.mode = "free";
    document.getElementById("modeLabel").textContent = "–†–µ–∂–∏–º: –°–≤–æ–±–æ–¥–Ω–∞—è –µ–∑–¥–∞";
    document.getElementById("modeLabel").style.background = "green";
  }
});

// –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
document.getElementById("citySelect").addEventListener("change", e => {
  const cityName = e.target.value;
  const city = cityMarkers[cityName];
  if (city) {
    map.setCenter(city.position);
    streetView.setPosition(city.position);
    streetView.setPov({ heading: 0, pitch: 0 });
  }
});

// —Ä–∞–¥–∏–æ
document.getElementById("radioToggle").addEventListener("click", () => {
  if (radioPlaying) {
    radio.pause();
    radioPlaying = false;
    document.getElementById("radioToggle").textContent = "‚ñ∂ –†–∞–¥–∏–æ";
  } else {
    radio.play();
    radioPlaying = true;
    document.getElementById("radioToggle").textContent = "‚è∏ –†–∞–¥–∏–æ";
  }
});

window.onload = function() {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    console.log("Telegram SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
  } catch(e) {
    console.error("–û—à–∏–±–∫–∞ Telegram SDK", e);
  }
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
