<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <style>
    /* ... —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
    /* (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ) */
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8" async defer></script>
</head>
<body>
  <div id="app-container">
    <div id="headerBar">
      <span id="cityLabel">–ì–æ—Ä–æ–¥:</span>
      <select id="citySelect">
        <option value="Berlin">–ë–µ—Ä–ª–∏–Ω</option>
        <option value="Leipzig">–õ–µ–π–ø—Ü–∏–≥</option>
        <option value="Dresden">–î—Ä–µ–∑–¥–µ–Ω</option>
        <option value="Novorossiysk">–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫</option>
      </select>
      <span id="voteResults">–í–ª–µ–≤–æ: 0 | ‚Üë: 0 | –í–ø—Ä–∞–≤–æ: 0</span>
    </div>
    <div id="topPanel">
      <div id="timerLabel"></div>
    </div>
    <div id="main-content">
      <div id="street-view"></div>
      <div id="controls">
        <div id="voteBtns">
          <button class="btn-vote left" data-dir="left">‚Üê</button>
          <button class="btn-vote straight" data-dir="straight">‚Üë</button>
          <button class="btn-vote right" data-dir="right">‚Üí</button>
        </div>
        <div id="mainBtns">
          <button class="btn-main start">–°—Ç–∞—Ä—Ç</button>
          <!-- <button class="btn-main drive">–ï–•–ê–¢–¨</button> –ö–ù–û–ü–ö–£ –£–î–ê–õ–Ø–ï–ú -->
          <button class="btn-main back">–ù–∞–∑–∞–¥</button>
          <button class="btn-main radio" onclick="window.open('https://t.me/fmusbot','_blank')">üéµ</button>
          <button class="btn-main map">–ö–∞—Ä—Ç–∞</button>
        </div>
      </div>
    </div>
    <div id="mapPopup">
      <button id="hideMapBtn">–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É ‚ñ≤</button>
      <div id="mapCanvas"></div>
    </div>
  </div>
  <script>
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGFvb3h5d3pubG9vZ3loZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDAyMzIsImV4cCI6MjA2NzU3NjIzMn0.t2wjdhhV_RfaB3aVQqDai546h5xNNBZpEu_lnrkL8Do";
    const BASE_URL = "https://qsdaooxywznloogyheyu.supabase.co";
    const CITIES = {
      Berlin: { lat: 52.5200, lng: 13.4050 },
      Leipzig: { lat: 51.3397, lng: 12.3731 },
      Dresden: { lat: 51.0504, lng: 13.7373 },
      Novorossiysk: { lat: 44.7236, lng: 37.7689 }
    };
    let selectedCity = localStorage.getItem("selectedCity") || "Berlin";
    document.getElementById("citySelect").value = selectedCity;
    let panorama, streetMap, mapPopup, mapRoutePath;
    let votes = { left: 0, straight: 0, right: 0 };
    let timerValue = 0, timerActive = false, timerInterval = null;
    let routeHistory = {};
    window.onload = () => {
      Telegram.WebApp.ready();
      initApp();
    };
    async function initApp() {
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById('street-view'),
        {
          position: CITIES[selectedCity],
          pov: { heading: 0, pitch: 0 },
          visible: true,
          addressControl: false,
          linksControl: false,
          panControl: false,
          zoomControl: false,
          enableCloseButton: false,
          showRoadLabels: false,
          disableDefaultUI: true
        }
      );
      panorama.setOptions({
        disableDefaultUI: true,
        linksControl: false,
        panControl: false,
        zoomControl: false,
        addressControl: false,
        showRoadLabels: false,
        enableCloseButton: false,
      });

      mapPopup = new google.maps.Map(document.getElementById('mapCanvas'), {
        center: CITIES[selectedCity], zoom: 14
      });
      mapRoutePath = new google.maps.Polyline({
        path: [CITIES[selectedCity]],
        geodesic: true,
        strokeColor: "#f90",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      mapRoutePath.setMap(mapPopup);
      routeHistory[selectedCity] = [CITIES[selectedCity]];
      syncCity(selectedCity);
      document.querySelector('.btn-main.map').onclick = showMapPopup;
      document.getElementById('hideMapBtn').onclick = hideMapPopup;
      document.getElementById('citySelect').onchange = function(e) {
        selectedCity = e.target.value;
        localStorage.setItem("selectedCity", selectedCity);
        syncCity(selectedCity);
      };
      document.querySelectorAll('.btn-vote').forEach(btn =>
        btn.onclick = () => castVote(btn.dataset.dir)
      );
      // –ö–Ω–æ–ø–∫—É drive –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º, –±–æ–ª—å—à–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ–º handler!
      // document.querySelector('.btn-main.drive').onclick = () => drive();
      document.querySelector('.btn-main.start').onclick = async () => {
        await resetToStart(selectedCity);
      };
      document.querySelector('.btn-main.back').onclick = () => Telegram.WebApp.close();
      setInterval(updateVotes, 2000);
      setInterval(drawRouteOnMap, 3000);
      updateVotes();
      drawRouteOnMap();
    }
    function syncCity(city) {
      if (panorama) panorama.setPosition(CITIES[city]);
      if (mapPopup) mapPopup.setCenter(CITIES[city]);
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      updateVotes();
      resetTimer();
    }
    async function updateVotes() {
      const url = `${BASE_URL}/rest/v1/votes_summary?select=direction,count&city=eq.${selectedCity}&mode=eq.voting`;
      const res = await fetch(url, { headers: { apikey: API_KEY } });
      const data = await res.json();
      votes = { left: 0, straight: 0, right: 0 };
      data.forEach(v => votes[v.direction] = v.count);
      document.getElementById("voteResults").textContent =
        `–í–ª–µ–≤–æ: ${votes.left} | ‚Üë: ${votes.straight} | –í–ø—Ä–∞–≤–æ: ${votes.right}`;
      const total = votes.left + votes.straight + votes.right;
      if (total > 0 && !timerActive) startTimer();
    }
    async function castVote(dir) {
      await fetch(`${BASE_URL}/functions/v1/cast_vote-ts`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: API_KEY,
          Authorization: `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ city: selectedCity, mode: "voting", direction: dir })
      });
      updateVotes();
    }
    function startTimer() {
      timerValue = 5;
      timerActive = true;
      const t = document.getElementById('timerLabel');
      t.classList.add('active');
      t.textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
      timerInterval = setInterval(() => {
        timerValue--;
        t.textContent = `–ü–æ–µ–¥–µ–º —á–µ—Ä–µ–∑: ${timerValue} —Å–µ–∫`;
        if (timerValue <= 0) {
          drive();
        }
      }, 1000);
    }
    function resetTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerActive = false;
      timerValue = 0;
      document.getElementById('timerLabel').classList.remove('active');
    }
    async function drive() {
      resetTimer();
      let maxDir = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
      if (votes[maxDir] === 0) return;
      let bestLink;
      try {
        bestLink = findBestLink(maxDir);
      } catch {
        alert("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è!");
        return;
      }
      let svService = new google.maps.StreetViewService();
      svService.getPanorama({ pano: bestLink.pano }, (data, status) => {
        if (status === google.maps.StreetViewStatus.OK) {
          const nextLatLng = data.location.latLng;
          panorama.setPosition(nextLatLng);
          panorama.setPov({ heading: bestLink.heading, pitch: 0 });
          if (!routeHistory[selectedCity]) routeHistory[selectedCity] = [];
          routeHistory[selectedCity].push({ lat: nextLatLng.lat(), lng: nextLatLng.lng() });
          drawRouteOnMap();
        }
      });
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${selectedCity}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }
    function findBestLink(dir) {
      const pov = panorama.getPov().heading;
      const links = panorama.getLinks() || [];
      const want = { straight: 0, left: 270, right: 90 }[dir];
      let best = { diff: Infinity, link: null };
      links.forEach(link => {
        let rel = (link.heading - pov + 360) % 360;
        let diff = Math.abs(rel - want);
        diff = Math.min(diff, 360 - diff);
        if (diff < best.diff) best = { diff, link };
      });
      if (!best.link) throw new Error('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞');
      return best.link;
    }
    async function resetToStart(city) {
      panorama.setPosition(CITIES[city]);
      panorama.setPov({ heading: 0, pitch: 0 });
      routeHistory[city] = [CITIES[city]];
      mapRoutePath.setPath([CITIES[city]]);
      await fetch(`${BASE_URL}/rest/v1/votes_summary?city=eq.${city}&mode=eq.voting`, {
        method: "PATCH",
        headers: {
          apikey: API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ count: 0 })
      });
      updateVotes();
    }
    function drawRouteOnMap() {
      if (!routeHistory[selectedCity]) return;
      mapRoutePath.setPath(routeHistory[selectedCity]);
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
    }
    function showMapPopup() {
      document.getElementById("mapPopup").style.display = "flex";
      mapPopup.setCenter(routeHistory[selectedCity][routeHistory[selectedCity].length - 1]);
      google.maps.event.trigger(mapPopup, 'resize');
    }
    function hideMapPopup() {
      document.getElementById("mapPopup").style.display = "none";
    }
  </script>
</body>
</html>
