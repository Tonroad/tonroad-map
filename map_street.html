<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TonRoad</title>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow: hidden; font-family: Arial, sans-serif; }
    #map { height: 33%; width: 100%; }
    #pano { height: 67%; width: 100%; position: relative; }
    #controls {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 999;
    }
    #status {
      position: absolute; top: 5px; left: 5px;
      padding: 5px 10px; color: #fff; font-weight: bold;
      border-radius: 5px;
      background-color: red;
      z-index: 999;
    }
    .vote-button {
      padding: 10px 20px; margin: 5px; font-size: 16px;
    }
    #driveButton {
      background-color: green; color: white;
      padding: 10px 20px; font-size: 16px;
      border: none; border-radius: 4px;
      margin-left: 5px;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="pano">
    <div id="status">Режим: Голосование</div>
    <div id="controls">
      <button id="left" class="vote-button">← Влево</button>
      <button id="straight" class="vote-button">↑ Прямо</button>
      <button id="right" class="vote-button">→ Вправо</button>
      <button id="driveButton">ЕХАТЬ</button>
    </div>
  </div>

  <script>
    let mode = 'voting'; // начнем с голосования
    let votes = {left: 0, straight: 0, right: 0};
    let map, panorama;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 44.7239, lng: 37.7689 },
        zoom: 14
      });

      panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
        position: { lat: 44.7239, lng: 37.7689 },
        pov: { heading: 165, pitch: 0 },
        disableDefaultUI: false
      });
      map.setStreetView(panorama);

      updateMode();

      document.getElementById("left").onclick = () => vote("left");
      document.getElementById("straight").onclick = () => vote("straight");
      document.getElementById("right").onclick = () => vote("right");
      document.getElementById("driveButton").onclick = () => drive();
    }

    function updateMode() {
      const status = document.getElementById("status");
      if (mode === "voting") {
        status.textContent = "Режим: Голосование";
        status.style.backgroundColor = "red";
        panorama.setOptions({clickToGo: false});
      } else {
        status.textContent = "Режим: Свободная езда";
        status.style.backgroundColor = "green";
        panorama.setOptions({clickToGo: true});
      }
    }

    function vote(direction) {
      if (mode !== "voting") return;
      votes[direction]++;
      alert(`Вы проголосовали: ${direction}`);
    }

    function drive() {
      if (mode !== "voting") return;
      let maxVotes = Math.max(votes.left, votes.straight, votes.right);
      if (maxVotes === 0) {
        alert("Нет голосов для движения");
        return;
      }
      let winner = Object.keys(votes).find(dir => votes[dir] === maxVotes);
      alert(`Поехали как выбрало большинство: ${winner}`);

      switch (winner) {
        case "left": panorama.setPov({heading: panorama.getPov().heading - 90, pitch: 0}); break;
        case "right": panorama.setPov({heading: panorama.getPov().heading + 90, pitch: 0}); break;
        case "straight": panorama.setPosition(panorama.getPosition()); break;
      }

      // сброс голосов
      votes = {left: 0, straight: 0, right: 0};
    }

    // Telegram init
    window.onload = function() {
      try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
      } catch(e) {
        console.error("Ошибка Telegram SDK", e);
      }
    };
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>
</body>
</html>
