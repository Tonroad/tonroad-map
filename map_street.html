<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TonRoad</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial;
    }
    #map {
      height: 33%;
      width: 100%;
    }
    #pano {
      height: 67%;
      width: 100%;
    }
    #controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      z-index: 999;
    }
    #controls button {
      font-size: 16px;
      padding: 10px 20px;
    }
    #goButton {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: green;
      color: white;
      font-size: 16px;
      padding: 10px 20px;
      z-index: 999;
      display: none;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      font-size: 14px;
      z-index: 999;
    }
    #voteLabel {
      position: absolute;
      top: 50px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 5px 10px;
      z-index: 999;
    }
    #modeSelect {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="status">Режим: Свободная езда</div>
  <select id="modeSelect">
    <option value="free">Свободная езда</option>
    <option value="vote">Голосование</option>
  </select>
  <div id="voteLabel">Влево: 0 | Прямо: 0 | Вправо: 0</div>
  <div id="map"></div>
  <div id="pano"></div>
  <div id="controls">
    <button id="left">← Влево</button>
    <button id="straight">↑ Прямо</button>
    <button id="right">→ Вправо</button>
  </div>
  <button id="goButton">Ехать</button>

  <script>
    let map, panorama;
    let votes = { left: 0, straight: 0, right: 0 };
    let currentMode = "free";

    function initMap() {
      const startPos = { lat: 44.7237, lng: 37.7689 }; // Новороссийск
      map = new google.maps.Map(document.getElementById("map"), {
        center: startPos,
        zoom: 16,
      });
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("pano"),
        {
          position: startPos,
          pov: { heading: 0, pitch: 0 },
          linksControl: true,
          panControl: true,
          zoomControl: true,
        }
      );
      map.setStreetView(panorama);

      updateModeUI();

      document.getElementById("modeSelect").addEventListener("change", (e) => {
        currentMode = e.target.value;
        updateModeUI();
      });

      document.getElementById("left").addEventListener("click", () => {
        votes.left++;
        updateVotes();
      });
      document.getElementById("straight").addEventListener("click", () => {
        votes.straight++;
        updateVotes();
      });
      document.getElementById("right").addEventListener("click", () => {
        votes.right++;
        updateVotes();
      });

      document.getElementById("goButton").addEventListener("click", () => {
        drive();
      });
    }

    function updateModeUI() {
      if (currentMode === "vote") {
        document.getElementById("status").textContent = "Режим: Голосование";
        document.getElementById("status").style.background = "red";
        document.getElementById("controls").style.display = "flex";
        document.getElementById("goButton").style.display = "block";
        panorama.setOptions({ linksControl: false });
      } else {
        document.getElementById("status").textContent = "Режим: Свободная езда";
        document.getElementById("status").style.background = "green";
        document.getElementById("controls").style.display = "none";
        document.getElementById("goButton").style.display = "none";
        panorama.setOptions({ linksControl: true });
      }
      updateVotes();
    }

    function updateVotes() {
      document.getElementById("voteLabel").textContent =
        `Влево: ${votes.left} | Прямо: ${votes.straight} | Вправо: ${votes.right}`;
    }

    function drive() {
      if (votes.left === 0 && votes.straight === 0 && votes.right === 0) {
        alert("Нет голосов для движения");
        return;
      }
      let direction;
      if (votes.left >= votes.straight && votes.left >= votes.right) {
        direction = "left";
      } else if (votes.right >= votes.straight && votes.right >= votes.left) {
        direction = "right";
      } else {
        direction = "straight";
      }
      const links = panorama.getLinks();
      let found = links.find(link => {
        if (direction === "left") return link.heading < 180;
        if (direction === "right") return link.heading > 180;
        return Math.abs(link.heading - panorama.getPov().heading) < 45;
      });
      if (found) {
        panorama.setPano(found.pano);
        panorama.setPov({ heading: found.heading, pitch: 0 });
      } else {
        alert("Нет подходящего направления для движения");
      }
      votes = { left: 0, straight: 0, right: 0 };
      updateVotes();
    }
  </script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=ВАШ_API_КЛЮЧ&callback=initMap">
  </script>
</body>
</html>
