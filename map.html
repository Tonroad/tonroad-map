<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>TonRoad Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .vote-popup {
      font-size: 14px;
    }
    .vote-btn {
      margin-top: 5px;
      display: block;
      padding: 4px;
      background-color: #4285F4;
      color: white;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
    }
    /* –∫–Ω–æ–ø–∫–∏ */
    #radioToggle, #streetBtn {
      position: absolute;
      right: 10px;
      z-index: 999;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
    }
    #radioToggle {
      top: 10px;
      background-color: orange;
    }
    #streetBtn {
      top: 50px;
      background-color: #28a745;
    }
  </style>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    window.onload = function() {
      try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
      } catch(e) {
        console.error("Telegram SDK init error", e);
      }
    }
  </script>
</head>
<body>
  <!-- –ö–Ω–æ–ø–∫–∞ ‚ñ∂/‚è∏ –¥–ª—è —Ä–∞–¥–∏–æ (Europe Plus) -->
  <button id="radioToggle">‚ñ∂ –†–∞–¥–∏–æ</button>
  <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ-–ø–ª–µ–µ—Ä -->
  <audio id="radioAudio"
         src="http://air.radiorecord.ru:8102/europaplus.ogg"
         loop preload="none"
         style="display:none;">
  </audio>

  <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Street View -->
  <button id="streetBtn">–ü–µ—Ä–µ–π—Ç–∏ –≤ Street View</button>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
  <div id="map"></div>

  <!-- –°–∫—Ä–∏–ø—Ç: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–¥–∏–æ -->
  <script>
    (function(){
      const audioEl = document.getElementById('radioAudio');
      const btn     = document.getElementById('radioToggle');
      let playing   = false;

      // –£—Å—Ç–∞–Ω–æ–≤–∏–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
      audioEl.volume = 0.5;

      btn.addEventListener('click', async () => {
        if (playing) {
          audioEl.pause();
          btn.textContent = '‚ñ∂ –†–∞–¥–∏–æ';
        } else {
          try {
            await audioEl.play();
            btn.textContent = '‚è∏ –†–∞–¥–∏–æ';
          } catch(err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–¥–∏–æ', err);
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞–¥–∏–æ: ' + err.message);
          }
        }
        playing = !playing;
      });
    })();
  </script>

  <!-- –°–∫—Ä–∏–ø—Ç: –∫–∞—Ä—Ç–∞ –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ -->
  <script>
    // –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ map_street.html
    document.getElementById('streetBtn').addEventListener('click', () => {
      window.location.href = 'map_street.html';
    });

    let voteState = { currentVote: null, routeLine: null };
    let map, cities, cityMarkers = {};

    function initMap() {
      cities = [
        { name: "Berlin",  position: { lat: 52.52,   lng: 13.405 }, votes: 0 },
        { name: "Leipzig", position: { lat: 51.3397, lng: 12.3731 }, votes: 0 },
        { name: "Dresden", position: { lat: 51.0504, lng: 13.7373 }, votes: 0 }
      ];

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: cities[0].position
      });

      cities.forEach(city => {
        const marker = new google.maps.Marker({
          position: city.position,
          map: map,
          title: city.name
        });

        const info = new google.maps.InfoWindow();
        city.info = info;
        city.marker = marker;

        updateInfoWindow(city);

        marker.addListener("click", () => {
          info.open(map, marker);
        });

        cityMarkers[city.name] = city;
      });
    }

    function updateInfoWindow(city) {
      const content = `
        <div class="vote-popup">
          <strong>${city.name}</strong><br/>
          <span>–ì–æ–ª–æ—Å–æ–≤: ${city.votes}</span><br/>
          <div class="vote-btn" onclick="registerVote('${city.name}')">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</div>
        </div>
      `;
      city.info.setContent(content);
    }

    function registerVote(cityName) {
      voteState.currentVote = cityName;
      const userId = window.telegramUserId || "unknown";

      fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ city: cityName, userId: userId })
      })
      .then(res => res.json())
      .then(data => {
        alert(`–ì–æ–ª–æ—Å –∑–∞ ${data.voted} –ø—Ä–∏–Ω—è—Ç —Å–µ—Ä–≤–µ—Ä–æ–º`);
        const votedCity = cityMarkers[cityName];
        if (votedCity) {
          votedCity.votes++;
          updateInfoWindow(votedCity);
        }
        if (data.winner && cityMarkers[data.winner]) {
          Object.values(cityMarkers).forEach(c => c.marker.setLabel(null));
          cityMarkers[data.winner].marker.setLabel({
            text: "üèÜ",
            color: "blue",
            fontWeight: "bold"
          });
        }
        drawLineTo(cityMarkers[cityName].position);
      })
      .catch(err => {
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞");
        console.error(err);
      });
    }

    function drawLineTo(destination) {
      if (voteState.routeLine) voteState.routeLine.setMap(null);
      const berlin = { lat: 52.52, lng: 13.405 };
      voteState.routeLine = new google.maps.Polyline({
        path: [berlin, destination],
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      voteState.routeLine.setMap(map);
    }
  </script>

  <!-- Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap"
    async defer>
  </script>
</body>
</html>
