<!DOCTYPE html><html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>TonRoad Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        html, body { height:100%; margin:0; padding:0; font-family: Arial, sans-serif; }
        #map { height:100%; width:100%; }
        .vote-popup { font-size: 14px; }
        .vote-btn { margin-top:5px; display:block; padding:4px; background-color:#4285F4; color:white; text-align:center; cursor:pointer; border-radius:4px; }
        /* –∫–Ω–æ–ø–∫–∏ */
        #streetBtn, #driveBtn, #radioToggle, #musicToggle, #radioSelect {
            position:absolute; right:10px; z-index:999;
            border:none; border-radius:4px; cursor:pointer;
        }
        #streetBtn { top:10px; background:#28a745; color:#fff; padding:8px 14px; }
        #driveBtn  { bottom:10px; background:green; color:#fff; padding:8px 14px; }
        #radioToggle { top:50px; background:orange; color:#fff; padding:8px 14px; }
        #musicToggle { top:90px; background:purple; color:#fff; padding:8px 14px; }
        #radioSelect, #musicSelect {
            position:absolute; right:10px; z-index:999;
            padding:5px; background:#fff; color:#000; border-radius:4px;
        }
        #radioSelect { top:130px; }
        #musicSelect { top:170px; }
    </style>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      window.onload = () => {
        try {
          const tg = Telegram.WebApp;
          tg.ready();
          window.telegramUserId = tg.initDataUnsafe?.user?.id || "unknown";
        } catch(e) {
          console.error('Telegram SDK init error', e);
        }
      };
    </script>
</head>
<body>
    <!-- –ü–µ—Ä–µ–π—Ç–∏ –≤ Street View -->
    <button id="streetBtn">–ü–µ—Ä–µ–π—Ç–∏ –≤ Street View</button><!-- –ì–æ–ª–æ—Å ¬´–ï–•–ê–¢–¨¬ª -->
<button id="driveBtn">–ï–•–ê–¢–¨</button>

<!-- –†–∞–¥–∏–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ -->
<button id="radioToggle">‚ñ∂ –†–∞–¥–∏–æ</button>
<select id="radioSelect">
  <option value="https://icecast.radiohitz.club/club.mp3">Radio Hitz</option>
  <option value="https://dpmp.jamradio.io/stream">Jam Radio</option>
  <option value="http://nashe1.hostingradio.ru:8000/nashe-128.mp3">–ù–∞—à–µ –†–∞–¥–∏–æ</option>
  <option value="https://mp3.donau3fm.at/donau3fm_high.mp3">Donau3FM</option>
</select>
<audio id="radioAudio" preload="none" style="display:none;"></audio>

<div id="map"></div>

<script>
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–¥–∏–æ –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
(function(){
  const audioEl = document.getElementById('radioAudio');
  const sel     = document.getElementById('radioSelect');
  const btn     = document.getElementById('radioToggle');
  let playing   = false;

  audioEl.loop   = true;
  audioEl.volume = 0.5;
  audioEl.src    = sel.value;

  sel.addEventListener('change', () => {
    audioEl.src = sel.value;
    if(playing) audioEl.play().catch(console.error);
  });

  btn.addEventListener('click', async () => {
    if(playing) {
      audioEl.pause();
      btn.textContent = '‚ñ∂ –†–∞–¥–∏–æ';
    } else {
      try {
        await audioEl.play();
        btn.textContent = '‚è∏ –†–∞–¥–∏–æ';
      } catch(err) {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–∞–¥–∏–æ', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–¥–∏–æ: ' + err.message);
      }
    }
    playing = !playing;
  });
})();
</script>

<script>
  // –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ map_street.html
  document.getElementById('streetBtn').addEventListener('click', () => {
    window.location.href = 'map_street.html';
  });

  // –õ–æ–≥–∏–∫–∞ –∫–∞—Ä—Ç—ã –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
  let voteState = { currentVote:null, routeLine:null };
  let map, cities, cityMarkers = {};

  function initMap() {
    cities = [
      { name:'Berlin',    position:{lat:52.52, lng:13.405}, votes:0 },
      { name:'Leipzig',   position:{lat:51.3397, lng:12.3731}, votes:0 },
      { name:'Dresden',   position:{lat:51.0504, lng:13.7373}, votes:0 }
    ];
    map = new google.maps.Map(document.getElementById('map'), { zoom:7, center:cities[0].position });

    cities.forEach(city => {
      const marker = new google.maps.Marker({ position:city.position, map, title:city.name });
      const info = new google.maps.InfoWindow();
      city.info = info; city.marker = marker;
      updateInfoWindow(city);
      marker.addListener('click', () => info.open(map, marker));
      cityMarkers[city.name] = city;
    });
  }

  function updateInfoWindow(city) {
    city.info.setContent(
      `<div class="vote-popup">
         <strong>${city.name}</strong><br/>
         <span>–ì–æ–ª–æ—Å–æ–≤: ${city.votes}</span><br/>
         <div class="vote-btn" onclick="registerVote('${city.name}')">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</div>
       </div>`
    );
  }

  function registerVote(cityName) {
    voteState.currentVote = cityName;
    const userId = window.telegramUserId || 'unknown';
    fetch('/api/vote', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ city:cityName, userId })
    })
    .then(r=>r.json())
    .then(data=>{
      alert(`–ì–æ–ª–æ—Å –∑–∞ ${data.voted} –ø—Ä–∏–Ω—è—Ç —Å–µ—Ä–≤–µ—Ä–æ–º`);
      cityMarkers[cityName].votes++;
      updateInfoWindow(cityMarkers[cityName]);
      if(data.winner && cityMarkers[data.winner]){
        Object.values(cityMarkers).forEach(c=>c.marker.setLabel(null));
        cityMarkers[data.winner].marker.setLabel({text:'üèÜ', color:'blue', fontWeight:'bold'});
      }
      drawLineTo(cityMarkers[cityName].position);
    })
    .catch(err=>{alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞'); console.error(err);});
  }

  function drawLineTo(destination) {
    if(voteState.routeLine) voteState.routeLine.setMap(null);
    const berlin = { lat:52.52, lng:13.405 };
    voteState.routeLine = new google.maps.Polyline({
      path:[berlin, destination],
      geodesic:true,
      strokeColor:'#FF0000', strokeOpacity:1.0, strokeWeight:3
    });
    voteState.routeLine.setMap(map);
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtao0F3Xm136OwD-LFglwhpBdOB6sht8&callback=initMap" async defer></script>

</body>
</html>
